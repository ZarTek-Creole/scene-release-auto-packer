---
name: users-roles-permissions
description: R√®gles strictes pour Users, Roles et Permissions granulaires
globs:
  - "**/*.{py,js,jsx,ts,tsx}"
---

# Users, Roles & Permissions - R√®gles Strictes

## üéØ Objectif

Assurer gestion stricte des utilisateurs, r√¥les et permissions granulaires selon matrice READ/WRITE/MOD/DELETE.

---

## üìã R√®gles Obligatoires

### 1. Users

**Validation** :
- ‚úÖ Username unique (UNIQUE)
- ‚úÖ Email valide (format)
- ‚úÖ Password fort (min 8 caract√®res, complexit√©)
- ‚úÖ Username non vide

**Structure** :
```python
users (
    id INT PRIMARY KEY,
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(255),
    note TEXT,
    password_hash VARCHAR(255) NOT NULL,
    active BOOLEAN DEFAULT TRUE,
    modify_at DATETIME,
    created_at DATETIME,
    created_by INT
)
```

**Password** :
- Hash avec bcrypt/argon2
- Validation force avant hash
- Jamais stock√© en clair

### 2. Roles

**R√¥les par d√©faut** :
- **Admin** : Toutes permissions
- **Operator** : Permissions limit√©es (READ/WRITE sur releases)

**Structure** :
```python
roles (
    id INT PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    created_at DATETIME
)
```

**Validation** :
- ‚úÖ Nom unique (UNIQUE)
- ‚úÖ Nom non vide
- ‚úÖ Description optionnelle

### 3. Permissions Granulaires

**Matrice** :
- **Resource** : `releases`, `rules`, `users`, `roles`, `config`
- **Action** : `READ`, `WRITE`, `MOD`, `DELETE`

**Logique automatique** :
- `MOD` ‚Üí implique `WRITE` ‚Üí implique `READ`
- `DELETE` ‚Üí ind√©pendant mais v√©rifie `MOD` recommand√©

**Structure** :
```python
permissions (
    id INT PRIMARY KEY,
    role_id INT,
    resource VARCHAR(50) NOT NULL,
    action VARCHAR(20) NOT NULL,
    created_at DATETIME,
    UNIQUE(role_id, resource, action)
)

# Relations
role_permissions (role_id, permission_id)
user_permissions (user_id, permission_id)
```

### 4. User ‚Üî Role (Many-to-Many)

**R√®gle** : Un utilisateur peut avoir UN r√¥le unique √† la fois.

**Structure** :
```python
user_roles (
    user_id INT,
    role_id INT,
    PRIMARY KEY (user_id, role_id)
)
```

**Validation** :
- ‚úÖ Un utilisateur = un r√¥le unique
- ‚úÖ R√¥le valide (existe)
- ‚úÖ Permission automatique selon r√¥le

### 5. User ‚Üî Group (Many-to-Many)

**R√®gle** : Un utilisateur peut appartenir √† PLUSIEURS groupes.

**Structure** :
```python
groups (
    id INT PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    created_at DATETIME
)

user_groups (
    user_id INT,
    group_id INT,
    PRIMARY KEY (user_id, group_id)
)
```

**Validation** :
- ‚úÖ Format groupe conforme (majuscules, chiffres)
- ‚úÖ Unicit√© `name` garantie

### 6. V√©rification Permissions

**D√©corateur** :
```python
from functools import wraps
from flask_jwt_extended import get_jwt_identity

def require_permission(resource: str, action: str):
    """D√©corateur v√©rification permission."""
    def decorator(f):
        @wraps(f)
        def wrapper(*args, **kwargs):
            user = get_current_user()
            if not user.has_permission(resource, action):
                return jsonify({"error": "Forbidden"}), 403
            return f(*args, **kwargs)
        return wrapper
    return decorator

# Usage
@require_permission("releases", "WRITE")
def create_release():
    pass
```

**Logique v√©rification** :
- Permissions directes utilisateur
- Permissions via r√¥le
- Logique automatique (MOD ‚Üí WRITE ‚Üí READ)

---

## üîç Validation Stricte

### Users

**Avant cr√©ation** :
- ‚úÖ Username unique
- ‚úÖ Email valide (si fourni)
- ‚úÖ Password fort

**Avant modification** :
- ‚úÖ Username unique (si chang√©)
- ‚úÖ Validation permissions

### Roles

**Avant cr√©ation** :
- ‚úÖ Nom unique
- ‚úÖ Permissions valides (resource, action)

**Avant suppression** :
- ‚úÖ V√©rifier utilisateurs assign√©s
- ‚úÖ Avertissement si utilisateurs affect√©s

### Permissions

**Logique automatique** :
- ‚úÖ `MOD` ‚Üí ajouter automatiquement `WRITE` et `READ`
- ‚úÖ `WRITE` ‚Üí ajouter automatiquement `READ`
- ‚úÖ `DELETE` ‚Üí ind√©pendant mais recommand√© avec `MOD`

---

## üö® Points Critiques

### R√¥le Unique

**R√®gle** : Un utilisateur = UN r√¥le unique √† la fois.

**Pas d'exception** : Matrice READ/WRITE/MOD/DELETE appliqu√©e strictement.

### Permissions Granulaires

**Matrice compl√®te** : Toutes ressources √ó toutes actions configur√©es.

**V√©rification** : Toujours v√©rifier permissions avant action.

---

## üìö R√©f√©rences

- **PRD-005** : `docs/PRDs/PRD-005-Utilisateurs.md`
- **PRD-006** : `docs/PRDs/PRD-006-Roles.md`
- **Database ERD** : `docs/DATABASE_ERD.md` (tables `users`, `roles`, `permissions`, etc.)
- **API Reference** : `docs/API_REFERENCE.md` (endpoints users, roles)

---

**Derni√®re mise √† jour** : 2025-11-01  
**Version** : 1.0.0  
**Priorit√©** : CRITIQUE ‚ö†Ô∏è
