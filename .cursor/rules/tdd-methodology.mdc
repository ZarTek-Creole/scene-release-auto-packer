---
alwaysApply: true
---
---
name: tdd-methodology
description: R√®gles strictes pour Test Driven Development (TDD)
globs:
  - "**/*.{py,js,jsx,ts,tsx}"
---

# TDD Methodology - R√®gles Strictes

## üéØ Principe Fondamental

**TDD est OBLIGATOIRE pour tout d√©veloppement**. Aucun code de production ne doit √™tre √©crit sans test correspondant √©crit en premier.

---

## üî¥üü¢üîÑ Cycle Red-Green-Refactor

### 1. Red : √âcrire Test Qui √âchoue
**Objectif** : D√©finir comportement attendu

```python
# ‚úÖ Exemple Backend
def test_create_user_success():
    """Test cr√©ation utilisateur r√©ussie."""
    user_data = {
        'username': 'testuser',
        'email': 'test@example.com',
        'password': 'securepass123'
    }
    
    response = client.post('/api/users', json=user_data)
    
    assert response.status_code == 201
    assert response.json['username'] == 'testuser'
    assert 'id' in response.json
```

```javascript
// ‚úÖ Exemple Frontend
describe('ReleaseCard', () => {
  it('should display release information', () => {
    const release = { id: 1, name: 'Test Release' };
    render(<ReleaseCard release={release} />);
    
    expect(screen.getByText('Test Release')).toBeInTheDocument();
  });
});
```

### 2. Green : Impl√©menter Code Minimal
**Objectif** : Faire passer le test avec code minimal

```python
# Code minimal pour faire passer le test
@app.route('/api/users', methods=['POST'])
def create_user():
    data = request.get_json()
    user = User(**data)
    db.session.add(user)
    db.session.commit()
    return jsonify(user.to_dict()), 201
```

### 3. Refactor : Am√©liorer Code
**Objectif** : Am√©liorer code tout en gardant tests verts

```python
# Code am√©lior√© avec validation, error handling
@app.route('/api/users', methods=['POST'])
def create_user():
    schema = UserSchema()
    try:
        data = schema.load(request.get_json())
    except ValidationError as err:
        return jsonify({'errors': err.messages}), 400
    
    user = User(**data)
    db.session.add(user)
    db.session.commit()
    return jsonify(schema.dump(user)), 201
```

---

## üìã R√®gles Strictes

### R√®gle 1 : Tests Avant Code
- ‚ùå **JAMAIS** √©crire code production sans test
- ‚úÖ **TOUJOURS** √©crire test d'abord (Red)
- ‚úÖ Test doit √©chouer initialement (v√©rifier)

### R√®gle 2 : Un Test, Un Comportement
- ‚úÖ Un test = Un comportement sp√©cifique
- ‚úÖ Nom clair : `test_<fonctionnalit√©>_<sc√©nario>()`
- ‚ùå √âviter tests multiples comportements dans un test

```python
# ‚úÖ Bon : Tests s√©par√©s
def test_create_user_success():
    # Test cr√©ation r√©ussie
    pass

def test_create_user_duplicate_username():
    # Test √©chec si username dupliqu√©
    pass

# ‚ùå √âviter : Test multiple comportements
def test_create_user():
    # Test succ√®s
    # Test √©chec
    # Test validation
    pass
```

### R√®gle 3 : Tests Isol√©s
- ‚úÖ Chaque test ind√©pendant
- ‚úÖ Setup/teardown propre (fixtures)
- ‚ùå Pas de d√©pendance entre tests

```python
# ‚úÖ Bon : Isolation avec fixtures
@pytest.fixture
def clean_db():
    db.create_all()
    yield
    db.drop_all()

def test_create_user(clean_db):
    # Test isol√©
    pass
```

### R√®gle 4 : Couverture 100%
- ‚úÖ **100% de couverture obligatoire** pour merge
- ‚úÖ V√©rifier avec `pytest --cov`
- ‚ùå Merge refus√© si couverture < 100%

```bash
# V√©rification couverture
pytest --cov=web --cov=src --cov-report=term --cov-report=html

# Doit afficher 100% coverage
```

### R√®gle 5 : Tests Rapides
- ‚úÖ Tests unitaires < 1s
- ‚úÖ Tests int√©gration < 5s
- ‚úÖ Tests E2E < 30s (acceptable)

---

## üìÅ Structure Tests

```
tests/
‚îú‚îÄ‚îÄ unit/              # Tests unitaires (70%)
‚îÇ   ‚îú‚îÄ‚îÄ test_models.py
‚îÇ   ‚îú‚îÄ‚îÄ test_services.py
‚îÇ   ‚îî‚îÄ‚îÄ test_utils.py
‚îú‚îÄ‚îÄ integration/       # Tests int√©gration (20%)
‚îÇ   ‚îú‚îÄ‚îÄ test_api.py
‚îÇ   ‚îî‚îÄ‚îÄ test_db.py
‚îú‚îÄ‚îÄ e2e/               # Tests E2E (10%)
‚îÇ   ‚îú‚îÄ‚îÄ test_wizard.py
‚îÇ   ‚îî‚îÄ‚îÄ test_navigation.py
‚îú‚îÄ‚îÄ conftest.py        # Fixtures partag√©es
‚îî‚îÄ‚îÄ fixtures/          # Donn√©es de test
```

---

## üõ†Ô∏è Outils et Configuration

### Backend (pytest)
```python
# conftest.py
import pytest
from web.app import create_app
from web.models import db

@pytest.fixture
def app():
    app = create_app('testing')
    with app.app_context():
        db.create_all()
        yield app
        db.drop_all()

@pytest.fixture
def client(app):
    return app.test_client()

@pytest.fixture
def auth_headers(client):
    # Login et retourner headers avec token
    response = client.post('/api/auth/login', json={
        'username': 'admin',
        'password': 'password'
    })
    token = response.json['access_token']
    return {'Authorization': f'Bearer {token}'}
```

### Tests E2E avec Playwright MCP

**‚ö†Ô∏è OBLIGATOIRE** : Utiliser Playwright MCP Tools pour tous les tests E2E au lieu de Playwright standard.

```python
# ‚úÖ Bon : Utiliser Playwright MCP pour tests E2E
def test_login_e2e():
    """Test login E2E avec Playwright MCP."""
    # 1. Naviguer vers application
    mcp_playwright_browser_navigate(url="http://localhost:5000")
    
    # 2. Capturer √©tat initial
    snapshot = mcp_playwright_browser_snapshot()
    assert "Login" in snapshot
    
    # 3. Interagir
    mcp_playwright_browser_type(
        element="username input",
        ref="input[name='username']",
        text="admin"
    )
    mcp_playwright_browser_click(
        element="login button",
        ref="button[type='submit']"
    )
    
    # 4. Valider r√©sultat
    mcp_playwright_browser_wait_for(text="Dashboard")
    final_snapshot = mcp_playwright_browser_snapshot()
    assert "Dashboard" in final_snapshot

# ‚ùå √âviter : Playwright standard si MCP disponible
# from playwright.sync_api import sync_playwright
# with sync_playwright() as p:
#     browser = p.chromium.launch()
#     # ...
```

**Voir** : `docs/MCP_TOOLS_GUIDE.md` et `.cursor/rules/mcp-tools-usage.mdc` pour d√©tails.

### Frontend (Jest/React Testing Library)
```javascript
// setupTests.js
import '@testing-library/jest-dom';

// test-utils.js
import { render } from '@testing-library/react';
import { ThemeProvider } from '../contexts/ThemeContext';

const AllTheProviders = ({ children }) => {
  return (
    <ThemeProvider>
      {children}
    </ThemeProvider>
  );
};

const customRender = (ui, options) =>
  render(ui, { wrapper: AllTheProviders, ...options });

export * from '@testing-library/react';
export { customRender as render };
```

### Tests E2E avec Playwright MCP

**‚ö†Ô∏è OBLIGATOIRE** : Utiliser Playwright MCP Tools pour tous les tests E2E au lieu de Playwright standard.

```python
# ‚úÖ Bon : Utiliser Playwright MCP pour tests E2E
def test_login_e2e():
    """Test login E2E avec Playwright MCP."""
    # 1. Naviguer vers application
    mcp_playwright_browser_navigate(url="http://localhost:5000")
    
    # 2. Capturer √©tat initial
    snapshot = mcp_playwright_browser_snapshot()
    assert "Login" in snapshot
    
    # 3. Interagir
    mcp_playwright_browser_type(
        element="username input",
        ref="input[name='username']",
        text="admin"
    )
    mcp_playwright_browser_type(
        element="password input",
        ref="input[name='password']",
        text="password"
    )
    mcp_playwright_browser_click(
        element="login button",
        ref="button[type='submit']"
    )
    
    # 4. Valider r√©sultat
    mcp_playwright_browser_wait_for(text="Dashboard")
    final_snapshot = mcp_playwright_browser_snapshot()
    assert "Dashboard" in final_snapshot

# ‚ùå √âviter : Playwright standard si MCP disponible
# from playwright.sync_api import sync_playwright
# with sync_playwright() as p:
#     browser = p.chromium.launch()
#     # ...
```

---

## ‚úÖ Checklist TDD

### Avant √âcrire Code
- [ ] Test √©crit et √©choue (Red)
- [ ] Test nomm√© clairement
- [ ] Test isol√© et ind√©pendant

### Apr√®s Impl√©mentation
- [ ] Test passe (Green)
- [ ] Code refactor√© si n√©cessaire
- [ ] Couverture 100% fonction test√©e
- [ ] Pas de r√©gression (autres tests passent)

### Avant Commit
- [ ] Tous tests passent
- [ ] Couverture 100%
- [ ] Tests rapides (< 5s unitaires, < 30s E2E)
- [ ] Pas de tests flaky

---

## üö´ Anti-Patterns √† √âviter

### ‚ùå √âcrire Code Puis Tests
```python
# ‚ùå Mauvais : Code avant tests
def create_user(data):
    user = User(**data)
    db.session.add(user)
    db.session.commit()
    return user

# Puis essayer d'√©crire test apr√®s
```

### ‚ùå Tests Trop G√©n√©raux
```python
# ‚ùå Mauvais : Test vague
def test_user():
    # Test tout
    pass

# ‚úÖ Bon : Test sp√©cifique
def test_create_user_with_valid_data():
    pass
```

### ‚ùå Tests D√©pendants
```python
# ‚ùå Mauvais : Test d√©pend d'un autre
def test_create_user():
    user = create_user()

def test_delete_user():
    user = create_user()  # D√©pend de test pr√©c√©dent
    delete_user(user.id)
```

---

## üìö Exemples Complets

### Exemple Backend : Endpoint API
```python
# 1. Red : Test
def test_get_user_by_id(client, auth_headers):
    # Cr√©er user
    user = User(username='test', email='test@test.com')
    db.session.add(user)
    db.session.commit()
    
    # Tester GET
    response = client.get(
        f'/api/users/{user.id}',
        headers=auth_headers
    )
    
    assert response.status_code == 200
    assert response.json['username'] == 'test'

# 2. Green : Impl√©menter
@app.route('/api/users/<int:user_id>')
@jwt_required()
def get_user(user_id):
    user = User.query.get_or_404(user_id)
    return jsonify(user.to_dict())

# 3. Refactor : Am√©liorer
@app.route('/api/users/<int:user_id>')
@jwt_required()
def get_user(user_id):
    user = User.query.get_or_404(user_id)
    schema = UserSchema()
    return jsonify(schema.dump(user))
```

### Exemple Frontend : Composant React
```javascript
// 1. Red : Test
describe('ReleaseForm', () => {
  it('should submit form with valid data', async () => {
    render(<ReleaseForm onSubmit={mockSubmit} />);
    
    fireEvent.change(screen.getByLabelText('Group'), {
      target: { value: 'TestGroup' }
    });
    fireEvent.click(screen.getByText('Submit'));
    
    await waitFor(() => {
      expect(mockSubmit).toHaveBeenCalledWith({
        group: 'TestGroup'
      });
    });
  });
});

// 2. Green : Impl√©menter
const ReleaseForm = ({ onSubmit }) => {
  const [group, setGroup] = useState('');
  
  const handleSubmit = (e) => {
    e.preventDefault();
    onSubmit({ group });
  };
  
  return (
    <form onSubmit={handleSubmit}>
      <input
        value={group}
        onChange={(e) => setGroup(e.target.value)}
      />
      <button type="submit">Submit</button>
    </form>
  );
};

// 3. Refactor : Am√©liorer
// Ajouter validation, error handling, etc.
```

---

## üö® Definition of Done

**‚ö†Ô∏è OBLIGATOIRE** : Avant de passer √† l'√©tape suivante, v√©rifier :

1. ‚úÖ Tous tests passent (100%)
2. ‚úÖ Couverture ‚â•90% (id√©al 100%)
3. ‚úÖ Documentation √† jour
4. ‚úÖ DEVBOOK mis √† jour

**JAMAIS continuer si √©tape non compl√©t√©e √† 100% avec tests.**

**Voir** : `.cursor/rules/definition-of-done.mdc` pour r√®gles compl√®tes

---

## üîó Liens

- **Definition of Done** : `.cursor/rules/definition-of-done.mdc` ‚ö†Ô∏è
- **Test Plan** : `docs/TEST_PLAN.md`
- **MCP Tools Guide** : `docs/MCP_TOOLS_GUIDE.md` ‚≠ê
- **DEVBOOK** : `docs/DEVBOOK.md`
- **CDC** : `docs/cdc.md`

---

**Derni√®re mise √† jour** : 2025-11-01  
**Version** : 1.0.0
