---
alwaysApply: true
---
---
name: project-v2-guidelines
description: R√®gles g√©n√©rales pour le projet eBook Scene Packer v2
globs:
  - "**/*.{py,js,jsx,ts,tsx,html,css,md}"
---

# Project v2 Guidelines - eBook Scene Packer v2

## üéØ Vision du Projet

Ce projet est une **refonte compl√®te (v2)** de l'application eBook Scene Packer. La v1 est conserv√©e dans `v1/` comme r√©f√©rence.

**Objectif** : Cr√©er une application moderne avec architecture propre, tests complets (TDD), et documentation exhaustive.

---

## üìÅ Structure du Projet

```
ebook.scene.packer/
‚îú‚îÄ‚îÄ v1/              # Version pr√©c√©dente (r√©f√©rence)
‚îú‚îÄ‚îÄ web/              # Backend Flask
‚îÇ   ‚îú‚îÄ‚îÄ app.py        # Application factory
‚îÇ   ‚îú‚îÄ‚îÄ blueprints/   # Blueprints modulaires
‚îÇ   ‚îú‚îÄ‚îÄ models/       # SQLAlchemy models
‚îÇ   ‚îú‚îÄ‚îÄ services/     # Services m√©tier
‚îÇ   ‚îî‚îÄ‚îÄ utils/        # Utilitaires
‚îú‚îÄ‚îÄ src/              # Code source partag√©
‚îú‚îÄ‚îÄ tests/            # Tests (TDD)
‚îÇ   ‚îú‚îÄ‚îÄ unit/         # Tests unitaires
‚îÇ   ‚îú‚îÄ‚îÄ integration/  # Tests int√©gration
‚îÇ   ‚îî‚îÄ‚îÄ e2e/          # Tests E2E
‚îú‚îÄ‚îÄ docs/             # Documentation
‚îÇ   ‚îú‚îÄ‚îÄ cdc.md        # Cahier des charges
‚îÇ   ‚îú‚îÄ‚îÄ DEVBOOK.md    # Suivi phases/√©tapes
‚îÇ   ‚îú‚îÄ‚îÄ todolist.md   # TodoList d√©taill√©e
‚îÇ   ‚îú‚îÄ‚îÄ PRDs/         # Product Requirement Documents
‚îÇ   ‚îî‚îÄ‚îÄ ...           # Autres docs
‚îî‚îÄ‚îÄ .cursor/rules/    # R√®gles Cursor
```

---

## üèóÔ∏è Architecture

### Backend (Flask)
- **Pattern** : Application Factory (`create_app()`)
- **Structure** : Blueprints modulaires par fonctionnalit√©
- **ORM** : Flask-SQLAlchemy
- **Validation** : Marshmallow schemas
- **Auth** : Flask-JWT-Extended
- **Caching** : Flask-Caching

### Frontend (React)
- **Composants** : Fonctionnels avec hooks
- **State** : Context API ou Redux selon besoin
- **Routing** : React Router v6
- **Styling** : Bootstrap 5
- **TypeScript** : Recommand√© (√† migrer progressivement)

### Database (MySQL)
- **Engine** : InnoDB (obligatoire)
- **Migrations** : Flask-Migrate
- **Naming** : snake_case pour tables/colonnes

---

## üìù Conventions de Code

### Python
- **Style** : PEP 8 (avec black/isort)
- **Type hints** : Obligatoires pour toutes fonctions
- **Docstrings** : Google style pour fonctions/classes
- **Imports** : Organis√©s (stdlib, third-party, local)
- **Early returns** : Pr√©f√©rer aux if/else imbriqu√©s

```python
# ‚úÖ Bon
def process_file(file_path: Path) -> dict[str, Any] | None:
    """Process a file and return metadata.
    
    Args:
        file_path: Path to the file to process.
        
    Returns:
        Dictionary with metadata or None if error.
    """
    if not file_path.exists():
        return None
    
    # ... processing ...
    return metadata

# ‚ùå √âviter
def process_file(file_path):
    if file_path.exists():
        # ... nested logic ...
```

### JavaScript/TypeScript
- **Style** : ESLint + Prettier
- **Composants** : Fonctionnels, PascalCase
- **Hooks** : Utiliser hooks React (useState, useEffect, etc.)
- **Props** : TypeScript interfaces si TypeScript utilis√©
- **Nommage** : camelCase pour variables/fonctions, PascalCase pour composants

```javascript
// ‚úÖ Bon
const ReleaseCard = ({ release, onEdit }) => {
  const [isLoading, setIsLoading] = useState(false);
  
  const handleEdit = () => {
    setIsLoading(true);
    onEdit(release.id);
  };
  
  return (
    <div className="release-card">
      {/* ... */}
    </div>
  );
};

// ‚ùå √âviter classes (sauf n√©cessit√©)
class ReleaseCard extends React.Component {
  // ...
}
```

---

## üß™ Tests (TDD Obligatoire)

### Cycle TDD
1. **Red** : √âcrire test qui √©choue
2. **Green** : Impl√©menter code minimal pour passer
3. **Refactor** : Am√©liorer code

### Structure Tests
- **Unitaires** : Tests fonctions/m√©thodes isol√©es
- **Int√©gration** : Tests interactions composants
- **E2E** : Tests flux utilisateur complets

### Exigences
- **Couverture** : 100% requis pour merge
- **Nommage** : `test_<functionality>_<scenario>()`
- **Isolation** : Chaque test ind√©pendant
- **Fixtures** : Utiliser fixtures pytest/Playwright

---

## üìö Documentation

### Code
- **Docstrings** : Toutes fonctions/classes
- **Comments** : Expliquer "pourquoi", pas "comment"
- **Type hints** : Types explicites partout

### Documentation Projet
- **CDC** : `docs/cdc.md` - Cahier des charges
- **DEVBOOK** : `docs/DEVBOOK.md` - Suivi phases/√©tapes
- **PRDs** : `docs/PRDs/` - Sp√©cifications fonctionnalit√©s
- **Tests** : `docs/TEST_PLAN.md` - Plan de tests

### Mise √† Jour
- **DEVBOOK** : Mettre √† jour √† chaque √©tape compl√©t√©e
- **PRDs** : Mettre √† jour si modification fonctionnalit√©
- **README** : Maintenir √† jour avec structure projet

---

## üîí S√©curit√©

### Obligatoire
- **JWT** : Tokens avec expiration
- **Chiffrement** : Credentials API/FTP (Fernet/AES-GCM)
- **Validation** : Input validation stricte
- **CORS** : Configuration s√©curis√©e
- **HTTPS** : Production uniquement

### Bonnes Pratiques
- **Secrets** : Variables d'environnement, jamais en code
- **SQL Injection** : Utiliser SQLAlchemy ORM (param√©tr√©)
- **XSS** : √âchapper output utilisateur
- **CSRF** : Protection formulaires

---

## ‚ö° Performance

### Backend
- **Caching** : Endpoints fr√©quemment acc√©d√©s
- **Database** : Indexes sur colonnes fr√©quentes
- **Queries** : Eager loading, √©viter N+1
- **Pagination** : Listes longues syst√©matiquement

### Frontend
- **Lazy Loading** : React.lazy() pour routes
- **Memoization** : React.memo, useMemo, useCallback
- **Bundle** : Code splitting automatique
- **Assets** : Optimisation images, minification

---

## üõ†Ô∏è MCP Tools - Utilisation Obligatoire

**Objectif** : Utiliser les MCP (Model Context Protocol) Tools pour am√©liorer productivit√©, qualit√© et documentation.

**Documentation compl√®te** : Voir `docs/MCP_TOOLS_GUIDE.md`

### R√®gles G√©n√©rales

1. **Toujours utiliser MCP Tools quand appropri√©** au lieu de m√©thodes manuelles
2. **Pr√©f√©rer MCP Tools pour** :
   - Tests E2E (Playwright Browser MCP)
   - Recherche documentation (Docs MCP, Context7 MCP)
   - Analyse codebase (Repomix MCP)
   - R√©solution probl√®mes complexes (Sequential Thinking MCP)

### MCP Tools Disponibles

#### 1. Playwright Browser MCP (Tests E2E)
**Quand utiliser** :
- ‚úÖ **Toujours** pour tests E2E et validation UI
- ‚úÖ Validation fonctionnalit√©s compl√®tes
- ‚úÖ Tests r√©gression
- ‚úÖ Validation accessibilit√©

**Outils cl√©s** :
- `mcp_playwright_browser_navigate` : Navigation
- `mcp_playwright_browser_snapshot` : Capture √©tat UI
- `mcp_playwright_browser_click/type` : Interactions
- `mcp_playwright_browser_take_screenshot` : Documentation

**Exemple** :
```python
# ‚úÖ Utiliser Playwright MCP pour tests E2E
mcp_playwright_browser_navigate(url="http://localhost:5000")
mcp_playwright_browser_snapshot()  # Valider √©tat
mcp_playwright_browser_type(element="username", text="admin")
mcp_playwright_browser_click(element="login-button")
mcp_playwright_browser_wait_for(text="Dashboard")
```

#### 2. Docs MCP Server (Documentation)
**Quand utiliser** :
- ‚úÖ Recherche exemples de code
- ‚úÖ Questions techniques sur biblioth√®ques
- ‚úÖ Recherche patterns React/Flask/Bootstrap
- ‚úÖ Indexation documentation (une fois par version)

**Outils cl√©s** :
- `mcp_docs-mcp-server_search_docs` : Recherche documentation
- `mcp_docs-mcp-server_scrape_docs` : Indexation (si nouvelle version)
- `mcp_docs-mcp-server_list_libraries` : V√©rifier biblioth√®ques disponibles

**Exemple** :
```python
# ‚úÖ Rechercher documentation avant impl√©mentation
results = mcp_docs-mcp-server_search_docs(
    library="react",
    query="useState hook examples",
    limit=5
)
```

#### 3. Context7 MCP (Documentation Structur√©e)
**Quand utiliser** :
- ‚úÖ Documentation structur√©e de biblioth√®ques
- ‚úÖ Exemples de code d√©taill√©s
- ‚úÖ Quand Docs MCP Server ne suffit pas

**Outils cl√©s** :
- `mcp_context7_resolve-library-id` : R√©soudre ID biblioth√®que
- `mcp_context7_get-library-docs` : R√©cup√©rer documentation

#### 4. Repomix MCP (Analyse Codebase)
**Quand utiliser** :
- ‚úÖ Analyse compl√®te codebase (refactoring majeur)
- ‚úÖ Recherche patterns dans tout le code
- ‚úÖ G√©n√©ration m√©triques et statistiques
- ‚úÖ Audit code complet

**Outils cl√©s** :
- `mcp_repomix_pack_codebase` : Packager codebase
- `mcp_repomix_grep_repomix_output` : Rechercher patterns

**‚ö†Ô∏è Important** : Utiliser avec parcimonie (pas √† chaque petite modification)

#### 5. Sequential Thinking MCP (Probl√®mes Complexes)
**Quand utiliser** :
- ‚úÖ Probl√®mes complexes multi-√©tapes
- ‚úÖ D√©cisions architecture importantes
- ‚úÖ Analyse approfondie de bugs
- ‚úÖ Planification fonctionnalit√©s complexes

**Outils cl√©s** :
- `mcp_sequential-thinking_sequentialthinking` : Pens√©e s√©quentielle

#### 6. Memory MCP (Knowledge Graph)
**Quand utiliser** :
- ‚úÖ Mod√©liser architecture projet
- ‚úÖ Documenter d√©cisions techniques
- ‚úÖ Cr√©er relations entre concepts

**Outils cl√©s** :
- `mcp_memory_create_entities` : Cr√©er entit√©s
- `mcp_memory_search_nodes` : Rechercher connaissances

### Workflow TDD avec MCP Tools

1. **Red** (√âcrire test) :
   - Utiliser `mcp_playwright_browser_snapshot` pour valider √©tat initial
   
2. **Green** (Impl√©menter) :
   - Utiliser `mcp_docs-mcp-server_search_docs` pour recherche documentation
   - Utiliser `mcp_repomix_grep_repomix_output` pour patterns similaires
   
3. **Refactor** (Am√©liorer) :
   - Utiliser `mcp_sequential-thinking_sequentialthinking` si complexe
   - Utiliser `mcp_playwright_browser_*` pour validation

4. **Validation** :
   - Utiliser `mcp_playwright_browser_take_screenshot` pour documentation
   - Utiliser `mcp_memory_create_entities` pour documenter d√©cisions

### Checklist Utilisation MCP Tools

**Avant utilisation** :
- [ ] Objectif clair identifi√©
- [ ] Tool appropri√© s√©lectionn√©
- [ ] Pr√©-requis v√©rifi√©s (serveur d√©marr√©, etc.)

**Pendant utilisation** :
- [ ] Utiliser tool de mani√®re isol√©e
- [ ] Capturer r√©sultats pour documentation

**Apr√®s utilisation** :
- [ ] Analyser r√©sultats
- [ ] Int√©grer dans code/documentation
- [ ] Mettre √† jour m√©moire si pertinent

### ‚ö†Ô∏è Anti-Patterns MCP Tools

```python
# ‚ùå Mauvais : Packager codebase pour petit changement
mcp_repomix_pack_codebase(...)  # Trop lourd pour changement mineur

# ‚úÖ Bon : Utiliser grep directement pour petits changements
# Utiliser pack_codebase seulement pour analyses majeures

# ‚ùå Mauvais : Screenshot √† chaque √©tape E2E
for step in steps:
    do_step()
    mcp_playwright_browser_take_screenshot()  # Trop de screenshots

# ‚úÖ Bon : Screenshot aux points critiques seulement
mcp_playwright_browser_take_screenshot(filename="final-state.png")

# ‚ùå Mauvais : Indexer m√™me biblioth√®que plusieurs fois
mcp_docs-mcp-server_scrape_docs(library="react")  # D√©j√† index√©

# ‚úÖ Bon : V√©rifier d'abord avec list_libraries
libraries = mcp_docs-mcp-server_list_libraries()
if "react" not in libraries:
    mcp_docs-mcp-server_scrape_docs(...)
```

---

## üõ†Ô∏è MCP Tools - Utilisation Obligatoire

**Objectif** : Utiliser les MCP (Model Context Protocol) Tools pour am√©liorer productivit√©, qualit√© et documentation.

**Documentation compl√®te** : Voir `docs/MCP_TOOLS_GUIDE.md`

### R√®gles G√©n√©rales

1. **Toujours utiliser MCP Tools quand appropri√©** au lieu de m√©thodes manuelles
2. **Pr√©f√©rer MCP Tools pour** :
   - Tests E2E (Playwright Browser MCP) ‚≠ê **OBLIGATOIRE**
   - Recherche documentation (Docs MCP, Context7 MCP)
   - Analyse codebase (Repomix MCP)
   - R√©solution probl√®mes complexes (Sequential Thinking MCP)

### MCP Tools Disponibles

- **Repomix MCP** : Analyse et packaging codebase
- **Docs MCP Server** : Documentation biblioth√®ques (React, Flask, Bootstrap index√©s)
- **Playwright Browser MCP** : Tests E2E et validation UI ‚≠ê
- **Context7 MCP** : Documentation structur√©e
- **Memory MCP** : Knowledge graph et entit√©s
- **Sequential Thinking MCP** : R√©solution probl√®mes complexes

**Voir** : `.cursor/rules/mcp-tools-usage.mdc` pour r√®gles d√©taill√©es et exemples

---

## üö® Definition of Done - R√®gle Absolue

**‚ö†Ô∏è CRITIQUE** : Voir `.cursor/rules/definition-of-done.mdc` pour r√®gles compl√®tes.

**R√®gle absolue** : **JAMAIS continuer √† l'√©tape/phase suivante si l'√©tape/phase en cours n'est pas compl√©t√©e √† 100% avec tests √† 100% et couverture minimale 90%.**

### Crit√®res Obligatoires Avant Progression

- ‚úÖ Code impl√©ment√© √† 100%
- ‚úÖ Tests √† 100% (tous passent)
- ‚úÖ Couverture ‚â•90% (id√©al 100%)
- ‚úÖ Documentation √† jour
- ‚úÖ Linters passent
- ‚úÖ DEVBOOK mis √† jour

**Voir** : `.cursor/rules/definition-of-done.mdc` pour d√©tails complets et exemples

---

## üö´ √Ä √âviter

- ‚ùå Code mort ou comment√©
- ‚ùå Magic numbers/strings (utiliser constantes)
- ‚ùå Imports inutilis√©s
- ‚ùå Duplication code (DRY)
- ‚ùå Nested callbacks profondes (promises/async-await)
- ‚ùå Mutations d'√©tat directes (React)
- ‚ùå Requ√™tes DB dans boucles
- ‚ùå Ignorer MCP Tools quand appropri√© (utiliser outils manuels au lieu de MCP)

---

## ‚úÖ Checklist Avant Commit

- [ ] Tests passent (100% couverture)
- [ ] Code format√© (black/isort pour Python, Prettier pour JS)
- [ ] Linters passent (pylint, ESLint)
- [ ] Type hints pr√©sents (Python)
- [ ] Docstrings pr√©sents (fonctions/classes)
- [ ] Pas de secrets en code
- [ ] Documentation mise √† jour si n√©cessaire
- [ ] MCP Tools utilis√©s quand appropri√© (tests E2E, documentation, analyse)

---

## üîó Liens Utiles

- **CDC** : `docs/cdc.md`
- **DEVBOOK** : `docs/DEVBOOK.md`
- **TodoList** : `docs/todolist.md`
- **PRDs** : `docs/PRDs/`
- **MCP Tools Guide** : `docs/MCP_TOOLS_GUIDE.md` ‚≠ê
- **v1/** : Version pr√©c√©dente (r√©f√©rence)

---

**Derni√®re mise √† jour** : 2025-11-01  
**Version** : 2.0.0
