---
name: templates-nfo
description: R√®gles strictes pour Templates NFO - Conformit√© Scene
globs:
  - "**/*.{py,js,jsx,ts,tsx}"
---

# Templates NFO - R√®gles Strictes

## üéØ Objectif

Assurer conformit√© absolue des Templates NFO avec les standards Scene et la r√®gle eBOOK [2022] scenerules.org.

---

## üìã R√®gles Obligatoires

### 1. Format Template

**Obligatoire** :
- ‚úÖ Format ASCII ‚â§ 80 colonnes par ligne
- ‚úÖ Support UTF-8 si n√©cessaire (mais ASCII pr√©f√©r√©)
- ‚úÖ Placeholders : `{{variable}}` (ex: `{{title}}`, `{{author}}`)
- ‚úÖ Conditionnelles : `{% if condition %}...{% endif %}`
- ‚úÖ Fonctions : `{{format_date(date)}}`, `{{uppercase(text)}}`, etc.

**Structure** :
```python
# ‚úÖ Bon : Template conforme
template = """
Title: {{title}}
Author: {{author}}
Publisher: {{publisher}}
Release Date: {{format_date(release_date)}}
{% if language %}
Language: {{language}}
{% endif %}
Group: {{group}}
Size: {{format_size(size)}}
"""
```

### 2. Source Template

**Priorit√©** :
1. ‚≠ê **Template extrait de r√®gle eBOOK [2022]** (scenerules.org)
2. Templates locaux (disque ou base de donn√©es)
3. Templates personnalis√©s upload√©s

**Validation** :
- ‚úÖ Template conforme √† structure r√®gle eBOOK [2022]
- ‚úÖ Largeur ‚â§ 80 colonnes v√©rifi√©e
- ‚úÖ Placeholders valides uniquement

### 3. Stockage Templates

**Options** :
- **Disque** : Fichiers `.nfo` ou `.template` dans r√©pertoire configur√©
- **Base de donn√©es** : Table `templates` (optionnel selon configuration)

**Configuration** :
- Param√®tre syst√®me (PRD-007) d√©termine stockage
- Migration possible disque ‚Üî DB

### 4. Rendu Template

**Processus** :
1. Charger template (r√®gle ou local)
2. Injecter m√©tadonn√©es dans placeholders
3. Ex√©cuter conditionnelles `{% if %}`
4. Appliquer fonctions `{{format_date()}}`, etc.
5. Valider largeur ‚â§ 80 colonnes
6. Retourner NFO final

**Validation** :
- ‚úÖ Tous placeholders remplac√©s
- ‚úÖ Format ASCII conforme
- ‚úÖ Largeur ‚â§ 80 colonnes
- ‚úÖ Structure conforme r√®gle

### 5. Pr√©visualisation

**UI** :
- **NFO Viewer** : Monospace UTF-8
- **Mise √† jour temps r√©el** : < 100ms
- **Validation largeur** : Avertissement si ligne > 80 colonnes
- **Syntax highlighting** : Si possible

---

## üîç Validation Stricte

### Avant Sauvegarde Template

```python
def validate_template(template: str) -> tuple[bool, list[str]]:
    """Valide template NFO."""
    errors = []
    
    # Validation largeur ‚â§ 80 colonnes
    for line in template.split('\n'):
        if len(line) > 80:
            errors.append(f"Ligne > 80 colonnes: {line[:50]}...")
    
    # Validation placeholders valides
    import re
    placeholders = re.findall(r'\{\{(\w+)\}\}', template)
    valid_placeholders = ['title', 'author', 'publisher', 'language', 
                         'format', 'source', 'release_date', 'group', 
                         'size', 'url']
    for placeholder in placeholders:
        if placeholder not in valid_placeholders:
            errors.append(f"Placeholder invalide: {placeholder}")
    
    return len(errors) == 0, errors
```

### Avant Packaging

**V√©rifications** :
- ‚úÖ Template s√©lectionn√© valide
- ‚úÖ Tous placeholders remplis
- ‚úÖ NFO g√©n√©r√© conforme ‚â§ 80 colonnes
- ‚úÖ Structure conforme r√®gle eBOOK [2022]

---

## üö® Points Critiques

### Template Source R√®gle

**‚ö†Ô∏è OBLIGATOIRE** : Template doit √™tre bas√© sur template de r√®gle eBOOK [2022] si disponible.

**Workflow** :
1. Charger r√®gle eBOOK [2022] (√âtape 3)
2. Extraire template de la r√®gle
3. Pr√©-remplir template dans √âtape 7
4. Permettre √©dition manuelle (mais validation r√®gle maintenue)

### Conformit√© ASCII

**R√®gle absolue** : Toutes lignes ‚â§ 80 colonnes.

**Exception** : UTF-8 accept√© mais ASCII pr√©f√©r√© selon r√®gle Scene.

---

## üìö R√©f√©rences

- **R√®gle eBOOK [2022]** : [scenerules.org](https://scenerules.org/)
- **PRD-002** : `docs/PRDs/PRD-002-Nouvelle-Release.md` (√âtape 7)
- **Scenerules Integration** : `docs/SCENERULES_INTEGRATION.md`
- **Database ERD** : `docs/DATABASE_ERD.md` (table `templates`)

---

**Derni√®re mise √† jour** : 2025-11-01  
**Version** : 1.0.0  
**Priorit√©** : CRITIQUE ‚ö†Ô∏è
