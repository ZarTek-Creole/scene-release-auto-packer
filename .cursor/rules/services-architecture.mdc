---
name: services-architecture
description: R√®gles strictes pour Services M√©tier - Architecture et S√©paration Logique
globs:
  - "**/*.py"
---

# Services Architecture - R√®gles Strictes

## üéØ Objectif

Assurer architecture coh√©rente des services m√©tier avec s√©paration logique, interfaces claires et gestion erreurs appropri√©e.

---

## üìã R√®gles Obligatoires

### 1. Structure Service

**Template Standard** :
```python
from typing import Optional, Dict, Any, List, Tuple
import logging
from web.models import ModelName
from web.extensions import db

logger = logging.getLogger(__name__)

class ServiceName:
    """Description du service."""
    
    def __init__(self):
        """Initialise service."""
        pass
    
    def method_name(self, param: str) -> Dict[str, Any]:
        """Description m√©thode.
        
        Args:
            param: Description param√®tre
            
        Returns:
            Dictionnaire avec r√©sultats
            
        Raises:
            ValueError: Si param√®tre invalide
            ServiceError: Si erreur service
        """
        try:
            # Logique service
            logger.info(f"Processing {param}")
            result = self._process(param)
            return {'success': True, 'data': result}
        except ValueError as e:
            logger.error(f"Validation error: {e}")
            raise
        except Exception as e:
            logger.exception(f"Service error: {e}")
            raise ServiceError(f"Failed to process: {e}")
    
    def _process(self, param: str) -> Any:
        """M√©thode priv√©e pour traitement."""
        # Logique interne
        pass
```

---

### 2. Services Obligatoires

**Services Must Have** :

#### Core Services
- ‚úÖ `PackagingService` : Logique packaging (package_ebook, package_tv, etc.)
- ‚úÖ `MetadataService` : Extraction/enrichissement m√©tadonn√©es
- ‚úÖ `TemplateService` : Rendu templates NFO
- ‚úÖ `JobService` : Gestion jobs (cr√©ation, statut, logs)
- ‚úÖ `AuthService` : Logique authentification (login, refresh, logout)

#### Critical Services (EBOOK)
- ‚ö†Ô∏è `RuleParserService` : Parse r√®gle eBOOK [2022] compl√®te
  - M√©thode `parse_ebook_rule_2022(content: str) -> EbookRuleSpec`
  - Extraction formats, template, contraintes
- ‚ö†Ô∏è `RuleValidationService` : Valide release contre r√®gle
  - M√©thode `validate_against_rule(release_data: dict, rule_spec: EbookRuleSpec) -> tuple[bool, list[str]]`
- ‚ö†Ô∏è `ScenerulesDownloadService` : T√©l√©charge r√®gles depuis scenerules.org
  - M√©thode `download_ebook_rule_2022() -> str`

#### Support Services
- ‚úÖ `FtpUploadService` : Upload FTP/SFTP
- ‚úÖ `RuleService` : Gestion rules (locales + scenerules.org)
- ‚úÖ `UserService` : Logique utilisateurs
- ‚úÖ `PermissionService` : V√©rification permissions

---

### 3. Principes Architecture

**S√©paration Logique** :
- ‚úÖ **Services** : Logique m√©tier uniquement
- ‚úÖ **Models** : Structure donn√©es, relations
- ‚úÖ **Blueprints** : Endpoints API, validation inputs
- ‚úÖ **Utils** : Fonctions utilitaires (pas de logique m√©tier)

**Interfaces Claires** :
```python
# ‚úÖ Bon : Interface claire, param√®tres typ√©s
def package_ebook(
    file_path: Path,
    group: str,
    rule_spec: EbookRuleSpec
) -> Dict[str, Any]:
    """Package ebook selon r√®gle."""
    pass

# ‚ùå √âviter : Interface vague
def package(data):
    """Package."""
    pass
```

---

### 4. Gestion Erreurs

**Exceptions Sp√©cifiques** :
```python
class ServiceError(Exception):
    """Erreur g√©n√©rique service."""
    pass

class ValidationError(ServiceError):
    """Erreur validation."""
    pass

class ProcessingError(ServiceError):
    """Erreur traitement."""
    pass

class RuleParsingError(ServiceError):
    """Erreur parsing r√®gle."""
    pass
```

**Utilisation** :
```python
def process(self, data: dict):
    """Process data."""
    if not data:
        raise ValidationError("Data is required")
    
    try:
        result = self._process(data)
    except Exception as e:
        logger.exception(f"Processing error: {e}")
        raise ProcessingError(f"Failed to process: {e}")
    
    return result
```

---

### 5. Logging

**Obligatoire** :
- ‚úÖ Logger par service : `logger = logging.getLogger(__name__)`
- ‚úÖ Log info : Actions importantes
- ‚úÖ Log error : Erreurs avec contexte
- ‚úÖ Log exception : Exceptions avec stack trace

**Exemple** :
```python
import logging

logger = logging.getLogger(__name__)

def package_ebook(self, file_path: Path):
    """Package ebook."""
    logger.info(f"Starting packaging for {file_path}")
    
    try:
        # Packaging
        result = self._do_packaging(file_path)
        logger.info(f"Packaging completed successfully: {result['release_name']}")
        return result
    except Exception as e:
        logger.exception(f"Packaging failed for {file_path}: {e}")
        raise
```

---

### 6. Tests Services

**Mock Dependencies** :
```python
from unittest.mock import Mock, patch
import pytest

class TestPackagingService:
    @patch('web.services.packaging.MediaInfo')
    def test_package_ebook_success(self, mock_mediainfo):
        """Test packaging ebook success."""
        service = PackagingService()
        mock_mediainfo.return_value.get_info.return_value = {...}
        
        result = service.package_ebook(
            Path('test.epub'),
            'TESTGROUP',
            rule_spec
        )
        
        assert result['success'] is True
        assert 'release_name' in result
```

---

### 7. Services Critiques EBOOK

#### RuleParserService

**Responsabilit√©s** :
- ‚úÖ T√©l√©charger r√®gle eBOOK [2022] depuis scenerules.org
- ‚úÖ Parser r√®gle compl√®te (formats, template, contraintes)
- ‚úÖ Extraire sp√©cifications dans `EbookRuleSpec`

**M√©thodes** :
```python
class RuleParserService:
    def download_ebook_rule_2022(self) -> str:
        """T√©l√©charge r√®gle eBOOK [2022]."""
        pass
    
    def parse_ebook_rule_2022(self, content: str) -> EbookRuleSpec:
        """Parse r√®gle compl√®te."""
        # Extraction formats, template, contraintes
        pass
```

#### RuleValidationService

**Responsabilit√©s** :
- ‚úÖ Valider release contre r√®gle compl√®te
- ‚úÖ Validation format, nommage, structure, NFO
- ‚úÖ Retourner erreurs d√©taill√©es

**M√©thodes** :
```python
class RuleValidationService:
    def validate_against_rule(
        self,
        release_data: dict,
        rule_spec: EbookRuleSpec
    ) -> Tuple[bool, List[str]]:
        """Valide release contre r√®gle."""
        errors = []
        # Validations compl√®tes
        return len(errors) == 0, errors
```

#### ScenerulesDownloadService

**Responsabilit√©s** :
- ‚úÖ T√©l√©charger r√®gles depuis scenerules.org
- ‚úÖ Mise en cache locale
- ‚úÖ Parsing automatique apr√®s t√©l√©chargement

**M√©thodes** :
```python
class ScenerulesDownloadService:
    BASE_URL = "https://scenerules.org"
    
    def download_ebook_rule_2022(self) -> str:
        """T√©l√©charge r√®gle eBOOK [2022]."""
        pass
    
    def cache_rule(self, rule_name: str, content: str):
        """Met en cache r√®gle locale."""
        pass
```

---

### 8. Services et Base de Donn√©es

**Session Management** :
```python
from web.extensions import db

class ServiceName:
    def create_item(self, data: dict):
        """Cr√©e item."""
        item = ModelName(**data)
        db.session.add(item)
        db.session.commit()
        return item
```

**Transactions** :
```python
def process_with_transaction(self, data: dict):
    """Process avec transaction."""
    try:
        # Op√©rations DB
        item = ModelName(**data)
        db.session.add(item)
        db.session.commit()
        return item
    except Exception:
        db.session.rollback()
        raise
```

---

### 9. Services et Fichiers

**Gestion Fichiers** :
```python
from pathlib import Path
import shutil

class FileService:
    def process_file(self, file_path: Path):
        """Process file."""
        if not file_path.exists():
            raise FileNotFoundError(f"File not found: {file_path}")
        
        # Traitement
        result_path = self._process(file_path)
        return result_path
```

---

### 10. Performance

**Optimisation** :
- ‚úÖ Cache r√©sultats co√ªteux
- ‚úÖ Lazy loading pour relations DB
- ‚úÖ Batch processing si possible

**Exemple** :
```python
from functools import lru_cache

class RuleService:
    @lru_cache(maxsize=100)
    def get_rule(self, rule_id: int) -> Rule:
        """Cache rule."""
        return Rule.query.get(rule_id)
```

---

## ‚úÖ Checklist Service

### Avant Commit
- [ ] Service conforme template standard
- [ ] M√©thodes avec types (type hints)
- [ ] Docstrings compl√®tes
- [ ] Exceptions sp√©cifiques
- [ ] Logging appropri√©
- [ ] Tests unitaires (mocks)
- [ ] Pas de logique m√©tier dans mod√®le
- [ ] Gestion erreurs robuste
- [ ] Documentation claire

---

## üö® Anti-Patterns

### ‚ùå Logique M√©tier dans Blueprint
```python
# ‚ùå Mauvais : Logique dans blueprint
@blueprint.route('/pack', methods=['POST'])
def pack():
    # Logique packaging ici
    file_path = request.json['file']
    # ... 100 lignes de logique
    return jsonify({'success': True})

# ‚úÖ Bon : Logique dans service
@blueprint.route('/pack', methods=['POST'])
def pack():
    data = request.json
    result = PackagingService().package_ebook(
        Path(data['file']),
        data['group'],
        rule_spec
    )
    return jsonify(result)
```

### ‚ùå Services D√©pendants Directement
```python
# ‚ùå Mauvais : D√©pendance directe
class ServiceA:
    def process(self):
        ServiceB().do_something()  # D√©pendance forte

# ‚úÖ Bon : Injection d√©pendance ou factory
class ServiceA:
    def __init__(self, service_b: ServiceB = None):
        self.service_b = service_b or ServiceB()
    
    def process(self):
        self.service_b.do_something()
```

---

## üìö R√©f√©rences

- **SCENERULES_INTEGRATION** : `docs/SCENERULES_INTEGRATION.md` (services critiques)
- **PRDs** : `docs/PRDs/` (sp√©cifications fonctionnelles)
- **API** : `docs/API_REFERENCE.md` (endpoints)

---

**Derni√®re mise √† jour** : 2025-11-01  
**Version** : 1.0.0
