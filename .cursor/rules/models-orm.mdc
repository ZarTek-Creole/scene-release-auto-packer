---
name: models-orm
description: RÃ¨gles strictes pour Models ORM SQLAlchemy - Structure et Relations
globs:
  - "**/*.py"
---

# Models ORM - RÃ¨gles Strictes

## ðŸŽ¯ Objectif

Assurer structure cohÃ©rente et complÃ¨te des modÃ¨les SQLAlchemy avec relations, contraintes et mÃ©thodes utilitaires.

---

## ðŸ“‹ RÃ¨gles Obligatoires

### 1. Structure ModÃ¨le

**Template Standard** :
```python
from datetime import datetime
from sqlalchemy import Column, Integer, String, ForeignKey, DateTime, Text, JSON, Boolean
from sqlalchemy.orm import relationship
from web.extensions import db

class ModelName(db.Model):
    """Description du modÃ¨le."""
    
    __tablename__ = 'table_name'
    
    # Colonnes
    id = Column(Integer, primary_key=True, autoincrement=True)
    name = Column(String(100), nullable=False, unique=True)
    created_at = Column(DateTime, default=datetime.utcnow, nullable=False)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # Relations
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False)
    user = relationship('User', backref='model_instances')
    
    def __repr__(self):
        return f'<ModelName {self.name}>'
    
    def to_dict(self):
        """Convertit modÃ¨le en dictionnaire."""
        return {
            'id': self.id,
            'name': self.name,
            'created_at': self.created_at.isoformat() if self.created_at else None,
        }
```

---

### 2. ModÃ¨les Obligatoires

**15 modÃ¨les** doivent Ãªtre crÃ©Ã©s (voir `docs/DATABASE_ERD.md`) :

#### Users & Auth
- âœ… `User` : Utilisateurs (username UNIQUE, password_hash)
- âœ… `Role` : RÃ´les (name, description)
- âœ… `Permission` : Permissions (resource, action)
- âœ… `Group` : Groups Scene (name UNIQUE)

#### Relations
- âœ… `UserGroup` : User â†” Group (many-to-many)
- âœ… `UserRole` : User â†” Role (many-to-many)
- âœ… `RolePermission` : Role â†” Permission (many-to-many)
- âœ… `UserPermission` : User â†’ Permission (direct)

#### Releases & Jobs
- âœ… `Release` : Releases crÃ©Ã©es (user_id, group_id, release_type, status, metadata JSON, config JSON)
- âœ… `Job` : Jobs de packaging (release_id, status, config_json JSON, logs TEXT)

#### Rules & Templates
- âœ… `Rule` : Rules Scene locales (name, content TEXT, scene, section, year)
- âœ… `Template` : Templates NFO (name, content TEXT, storage)

#### Configurations
- âœ… `ApiConfig` : Configurations APIs (user_id, name, api_key_encrypted TEXT)
- âœ… `Destination` : Destinations FTP/SSH (user_id, name, host, port, user, password_encrypted TEXT, type)
- âœ… `Preference` : PrÃ©fÃ©rences utilisateur (user_id, key, value TEXT)

---

### 3. Relations

**Many-to-Many** :
```python
# User â†” Group
user_groups = db.Table('user_groups',
    db.Column('user_id', Integer, ForeignKey('users.id'), primary_key=True),
    db.Column('group_id', Integer, ForeignKey('groups.id'), primary_key=True)
)

class User(db.Model):
    groups = relationship('Group', secondary=user_groups, backref='users')
```

**One-to-Many** :
```python
class User(db.Model):
    releases = relationship('Release', backref='user', lazy='dynamic')

class Release(db.Model):
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False)
```

---

### 4. Contraintes Base de DonnÃ©es

**Obligatoires** :
- âœ… **PRIMARY KEY** : `id` (INTEGER AUTO_INCREMENT) pour toutes tables
- âœ… **UNIQUE** : Username, groupe name, etc. selon spÃ©cifications
- âœ… **FOREIGN KEY** : Toutes relations avec `ON DELETE CASCADE` ou `RESTRICT`
- âœ… **NOT NULL** : Colonnes critiques (username, password_hash, etc.)
- âœ… **INDEX** : Colonnes frÃ©quemment utilisÃ©es (username, user_id, status)

**Exemple** :
```python
username = Column(String(100), nullable=False, unique=True, index=True)
user_id = Column(Integer, ForeignKey('users.id', ondelete='CASCADE'), nullable=False, index=True)
```

---

### 5. MÃ©thodes Utilitaires

**MÃ©thodes Obligatoires** :

#### `to_dict()`
```python
def to_dict(self):
    """Convertit modÃ¨le en dictionnaire."""
    return {
        'id': self.id,
        'name': self.name,
        'created_at': self.created_at.isoformat() if self.created_at else None,
    }
```

#### `from_dict()` (optionnel, selon besoin)
```python
@classmethod
def from_dict(cls, data: dict):
    """CrÃ©e instance depuis dictionnaire."""
    return cls(**data)
```

#### `__repr__()`
```python
def __repr__(self):
    return f'<ModelName {self.name}>'
```

---

### 6. Validation Champs

**Avant Sauvegarde** :
```python
from marshmallow import Schema, fields, validate

class UserSchema(Schema):
    username = fields.Str(required=True, validate=validate.Length(min=3, max=100))
    password = fields.Str(required=True, validate=validate.Length(min=8))
```

**Dans ModÃ¨le** :
```python
from sqlalchemy.orm import validates

class User(db.Model):
    @validates('username')
    def validate_username(self, key, value):
        if not value or len(value) < 3:
            raise ValueError("Username must be at least 3 characters")
        return value
```

---

### 7. SÃ©curitÃ©

**Chiffrement** :
- âœ… **Credentials** : API keys, passwords â†’ Chiffrement Fernet avant stockage
- âœ… **Sensitive data** : Dans colonnes `*_encrypted` (TEXT)

**Exemple** :
```python
from web.utils.crypto import encrypt_fernet, decrypt_fernet

class ApiConfig(db.Model):
    api_key_encrypted = Column(Text, nullable=False)
    
    @property
    def api_key(self):
        """DÃ©chiffre API key."""
        return decrypt_fernet(self.api_key_encrypted)
    
    @api_key.setter
    def api_key(self, value: str):
        """Chiffre API key."""
        self.api_key_encrypted = encrypt_fernet(value)
```

---

### 8. Performance

**Indexes** :
```python
# Colonnes frÃ©quemment utilisÃ©es
username = Column(String(100), index=True)
user_id = Column(Integer, ForeignKey('users.id'), index=True)
status = Column(String(50), index=True)
created_at = Column(DateTime, index=True)
```

**Queries OptimisÃ©es** :
```python
# âœ… Bon : Eager loading
releases = Release.query.options(joinedload(Release.user)).all()

# âŒ Ã‰viter : N+1 queries
for release in Release.query.all():
    user = release.user  # RequÃªte supplÃ©mentaire
```

---

### 9. Timestamps

**Obligatoires** :
- âœ… `created_at` : DateTime, default=datetime.utcnow
- âœ… `updated_at` : DateTime, default=datetime.utcnow, onupdate=datetime.utcnow

---

### 10. JSON Columns

**Format Standard** :
```python
metadata = Column(JSON, nullable=True)  # Pour donnÃ©es flexibles
config_json = Column(JSON, nullable=True)  # Pour configurations
```

**Utilisation** :
```python
release.metadata = {'title': 'Test', 'author': 'Author'}
# Automatiquement sÃ©rialisÃ©/dÃ©sÃ©rialisÃ© par SQLAlchemy
```

---

## âœ… Checklist ModÃ¨le

### Avant Commit
- [ ] ModÃ¨le conforme template standard
- [ ] Toutes colonnes avec types corrects
- [ ] Contraintes base de donnÃ©es (PRIMARY KEY, UNIQUE, FOREIGN KEY)
- [ ] Indexes sur colonnes frÃ©quentes
- [ ] Relations dÃ©finies correctement
- [ ] MÃ©thodes `to_dict()`, `__repr__()` prÃ©sentes
- [ ] Validation champs (Marshmallow schema)
- [ ] Timestamps (`created_at`, `updated_at`)
- [ ] Tests unitaires modÃ¨le
- [ ] Documentation docstring complÃ¨te

---

## ðŸš¨ Anti-Patterns

### âŒ Pas de Logique MÃ©tier dans ModÃ¨le
```python
# âŒ Mauvais : Logique mÃ©tier dans modÃ¨le
class User(db.Model):
    def process_release(self):
        # Logique packaging ici
        pass

# âœ… Bon : Logique dans Service
class ReleaseService:
    def process_release(self, user: User, release: Release):
        # Logique packaging ici
        pass
```

### âŒ Pas de RequÃªtes Complexes dans ModÃ¨le
```python
# âŒ Mauvais : RequÃªte complexe dans modÃ¨le
class Release(db.Model):
    @classmethod
    def find_active_releases(cls):
        return cls.query.filter_by(status='active').join(User).all()

# âœ… Bon : Dans Service ou Blueprint
class ReleaseService:
    @staticmethod
    def find_active_releases():
        return Release.query.filter_by(status='active').join(User).all()
```

---

## ðŸ“š RÃ©fÃ©rences

- **ERD** : `docs/DATABASE_ERD.md` (schÃ©ma complet)
- **API** : `docs/API_REFERENCE.md` (endpoints)
- **PRDs** : `docs/PRDs/` (spÃ©cifications fonctionnelles)

---

**DerniÃ¨re mise Ã  jour** : 2025-11-01  
**Version** : 1.0.0
