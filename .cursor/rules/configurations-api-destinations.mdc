---
name: configurations-api-destinations
description: R√®gles strictes pour Configurations, APIs et Destinations FTP/SSH
globs:
  - "**/*.{py,js,jsx,ts,tsx}"
---

# Configurations, APIs & Destinations - R√®gles Strictes

## üéØ Objectif

Assurer gestion s√©curis√©e des configurations syst√®me, APIs externes et destinations FTP/SSH avec chiffrement Fernet.

---

## üìã R√®gles Obligatoires

### 1. Chiffrement Credentials

**Algorithme** : **Fernet** (symmetric encryption)

**Chiffrement obligatoire** :
- ‚úÖ API keys (APIs externes)
- ‚úÖ FTP/SSH passwords
- ‚úÖ FTP/SSH usernames (si sensible)
- ‚úÖ Tokens secrets

**Service** : `CryptoService`

**Structure** :
```python
from cryptography.fernet import Fernet

class CryptoService:
    def __init__(self, key: bytes):
        self.cipher = Fernet(key)
    
    def encrypt(self, plaintext: str) -> str:
        """Chiffre texte."""
        return self.cipher.encrypt(plaintext.encode()).decode()
    
    def decrypt(self, ciphertext: str) -> str:
        """D√©chiffre texte."""
        return self.cipher.decrypt(ciphertext.encode()).decode()
```

### 2. API Configurations

**Structure** :
```python
api_configs (
    id INT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    api_key_encrypted TEXT NOT NULL,
    api_url VARCHAR(500),
    user_id INT,
    created_at DATETIME
)
```

**Validation** :
- ‚úÖ API key chiffr√©e avant stockage
- ‚úÖ URL valide (si fournie)
- ‚úÖ Nom unique par utilisateur (optionnel)

**Test connexion** :
- ‚úÖ Endpoint test connexion API
- ‚úÖ Validation credentials avant sauvegarde

### 3. Destinations FTP/SSH

**Structure** :
```python
destinations (
    id INT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    type ENUM('FTP', 'SFTP', 'SSH') NOT NULL,
    host VARCHAR(255) NOT NULL,
    port INT,
    username VARCHAR(100),
    password_encrypted TEXT,
    remote_path VARCHAR(500),
    user_id INT,
    created_at DATETIME
)
```

**Chiffrement** :
- ‚úÖ Password chiffr√© (Fernet)
- ‚úÖ Username chiffr√© si sensible (optionnel)

**Test connexion** :
- ‚úÖ Endpoint test connexion FTP/SSH
- ‚úÖ Validation connexion avant sauvegarde
- ‚úÖ Avertissement si connexion √©choue

### 4. Param√®tres Syst√®me

**Structure** :
```python
# Fichier config ou base de donn√©es
system_config = {
    "paths": {
        "templates_storage": "disk|db",
        "releases_path": "/path/to/releases",
        "backup_path": "/path/to/backup"
    },
    "limits": {
        "max_file_size": 20 * 1024 * 1024 * 1024,  # 20GB
        "max_releases_per_user": 1000
    },
    "logs": {
        "level": "INFO",
        "path": "/path/to/logs"
    }
}
```

**Configuration** :
- ‚úÖ Param√®tres configurables (PRD-007)
- ‚úÖ Validation valeurs
- ‚úÖ Documentation param√®tres

### 5. Pr√©f√©rences Utilisateur

**Structure** :
```python
preferences (
    id INT PRIMARY KEY,
    user_id INT UNIQUE,
    theme ENUM('light', 'dark') DEFAULT 'light',
    language VARCHAR(10) DEFAULT 'fr',
    notifications BOOLEAN DEFAULT TRUE,
    created_at DATETIME,
    updated_at DATETIME
)
```

**Validation** :
- ‚úÖ Theme valide ('light', 'dark')
- ‚úÖ Language valide (codes ISO)
- ‚úÖ Unicit√© `user_id`

---

## üîç Validation Stricte

### API Configurations

**Avant sauvegarde** :
- ‚úÖ API key chiffr√©e
- ‚úÖ URL valide (si fournie)
- ‚úÖ Test connexion r√©ussi (optionnel mais recommand√©)

### Destinations FTP/SSH

**Avant sauvegarde** :
- ‚úÖ Password chiffr√©
- ‚úÖ Host valide
- ‚úÖ Port valide (1-65535)
- ‚úÖ Test connexion r√©ussi (OBLIGATOIRE)

**Test connexion** :
- Endpoint : `POST /api/destinations/:id/test`
- Retour : Succ√®s/√©chec + message
- Validation avant packaging upload

---

## üö® Points Critiques

### Chiffrement Obligatoire

**R√®gle absolue** : Jamais stocker credentials en clair.

**Fernet** : Utiliser Fernet pour tous credentials sensibles.

### Test Connexion

**OBLIGATOIRE** : Tester connexion FTP/SSH avant sauvegarde destination.

**Avant upload** : Re-tester connexion avant upload release.

---

## üìö R√©f√©rences

- **PRD-007** : `docs/PRDs/PRD-007-Configurations.md`
- **Database ERD** : `docs/DATABASE_ERD.md` (tables `api_configs`, `destinations`, `preferences`)
- **API Reference** : `docs/API_REFERENCE.md` (endpoints configurations)

---

**Derni√®re mise √† jour** : 2025-11-01  
**Version** : 1.0.0  
**Priorit√©** : CRITIQUE ‚ö†Ô∏è
