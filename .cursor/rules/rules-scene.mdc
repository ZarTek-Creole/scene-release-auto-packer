---
name: rules-scene
description: R√®gles strictes pour Rules Scene - Int√©gration scenerules.org
globs:
  - "**/*.{py,js,jsx,ts,tsx}"
---

# Rules Scene - R√®gles Strictes

## üéØ Objectif

Assurer int√©gration compl√®te et validation stricte des r√®gles Scene depuis scenerules.org.

---

## üìã R√®gles Obligatoires

### 1. Source R√®gles

**Priorit√©** :
1. ‚≠ê **scenerules.org** : T√©l√©chargement automatique (PRIORIT√â)
2. **Rules locales** : Stock√©es en base de donn√©es (t√©l√©charg√©es depuis scenerules.org)
3. **Upload** : R√®gles personnalis√©es upload√©es

**R√®gle eBOOK Prioritaire** :
- **[2022] eBOOK** (English) ‚≠ê **OBLIGATOIRE** pour packaging EBOOK
- Source : [scenerules.org](https://scenerules.org/)
- Format : NFO (.nfo) avec sp√©cifications compl√®tes

### 2. T√©l√©chargement scenerules.org

**Service** : `ScenerulesDownloadService`

**Processus** :
1. D√©terminer URL r√®gle (ex: `2022_eBOOK.nfo`)
2. T√©l√©charger depuis scenerules.org
3. Parser r√®gle compl√®te
4. Stocker en cache local
5. Sauvegarder en base de donn√©es

**Mise en cache** :
- Cache local pour performance
- V√©rification mise √† jour p√©riodique
- Synchronisation automatique optionnelle

### 3. Parsing R√®gle Compl√®te

**Service** : `RuleParserService`

**Extraction obligatoire** :
- ‚úÖ Formats accept√©s (EPUB, PDF, MOBI, etc.)
- ‚úÖ Template NFO standardis√©
- ‚úÖ Contraintes nommage (regex)
- ‚úÖ Structure release (fichiers requis)
- ‚úÖ Contraintes techniques (taille, qualit√©)
- ‚úÖ R√®gles de validation

**Structure** :
```python
@dataclass
class EbookRuleSpec:
    accepted_formats: list[str]
    nfo_template: str
    naming_pattern: re.Pattern
    release_structure: dict
    validations: list[Callable]
    constraints: dict
```

### 4. Validation contre R√®gle

**Service** : `RuleValidationService`

**Validations obligatoires** :
- ‚úÖ Format fichier source conforme
- ‚úÖ Nommage conforme (regex)
- ‚úÖ Structure release conforme
- ‚úÖ NFO conforme template r√®gle
- ‚úÖ Toutes contraintes respect√©es

**Processus** :
```python
def validate_against_rule(
    release_data: dict, 
    rule_spec: EbookRuleSpec
) -> tuple[bool, list[str]]:
    """Valide release contre r√®gle compl√®te."""
    errors = []
    
    # Validation format
    if release_data['file_format'] not in rule_spec.accepted_formats:
        errors.append(f"Format non accept√©")
    
    # Validation nommage
    if not rule_spec.naming_pattern.match(release_data['release_name']):
        errors.append("Nommage non conforme")
    
    # Validation structure
    if not validate_structure(release_data, rule_spec.release_structure):
        errors.append("Structure non conforme")
    
    # Validation NFO
    if not validate_nfo(release_data['nfo'], rule_spec.nfo_template):
        errors.append("NFO non conforme")
    
    return len(errors) == 0, errors
```

### 5. Organisation Rules

**Structure** :
- **Sc√®ne** : English, French, German, Polish, Spanish, etc.
- **Section** : eBOOK, TV-720p, TV-SD, X264, X265, etc.
- **Ann√©e** : Ann√©e de publication/mise √† jour

**Filtrage** :
- Par sc√®ne
- Par section
- Par ann√©e
- Par type release (EBOOK, TV, etc.)

---

## üîç Validation Stricte

### Avant Utilisation R√®gle

**Checklist** :
- [ ] R√®gle charg√©e compl√®tement depuis scenerules.org
- [ ] Parsing r√©ussi (formats, template, contraintes extraits)
- [ ] R√®gle valide et compl√®te
- [ ] Sp√©cification `EbookRuleSpec` compl√®te stock√©e

### Pendant Packaging

**Validations √† chaque √©tape** :
- **√âtape 4** : Format fichier conforme r√®gle
- **√âtape 7** : Template conforme r√®gle
- **√âtape 8** : Structure conforme r√®gle
- **Packaging** : Nommage conforme r√®gle

---

## üö® Points Critiques

### Conformit√© Absolue

**‚ùå JAMAIS** :
- Packager sans r√®gle charg√©e
- Ignorer contraintes r√®gle
- Cr√©er release non conforme
- Utiliser template non conforme

**‚úÖ TOUJOURS** :
- Charger r√®gle compl√®te
- Valider contre r√®gle
- Appliquer r√®gle strictement
- Utiliser template de la r√®gle

### R√®gle eBOOK [2022]

**PRIORIT√â ABSOLUE** : R√®gle [2022] eBOOK obligatoire pour packaging EBOOK.

**Autres sc√®nes** : German, Polish, etc. selon besoin utilisateur.

---

## üìö R√©f√©rences

- **Scenerules Integration** : `docs/SCENERULES_INTEGRATION.md` ‚≠ê
- **PRD-002** : `docs/PRDs/PRD-002-Nouvelle-Release.md` (√âtape 3)
- **PRD-004** : `docs/PRDs/PRD-004-Rules.md`
- **Database ERD** : `docs/DATABASE_ERD.md` (table `rules`)
- **Site officiel** : [scenerules.org](https://scenerules.org/)

---

**Derni√®re mise √† jour** : 2025-11-01  
**Version** : 1.0.0  
**Priorit√©** : CRITIQUE ‚ö†Ô∏è
