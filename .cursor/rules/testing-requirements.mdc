---
alwaysApply: true
---
---
name: testing-requirements
description: Exigences strictes pour les tests
globs:
  - "**/*.{py,js,jsx,ts,tsx}"
---

# Testing Requirements - eBook Scene Packer v2

## üéØ Exigences G√©n√©rales

### Obligatoire
- ‚úÖ **TDD strict** : Tests avant code (cycle Red-Green-Refactor)
- ‚úÖ **Couverture 100%** : Tous merge refus√©s si < 100%
- ‚úÖ **Tests isol√©s** : Aucune d√©pendance entre tests
- ‚úÖ **Tests rapides** : < 1s unitaires, < 5s int√©gration

---

## üìä Types de Tests

### 1. Tests Unitaires (70% du total)

**Objectif** : Tester fonctions/m√©thodes isol√©es

**Exigences** :
- Ex√©cution < 1s par test
- Isolation compl√®te (mocks pour d√©pendances)
- Un test = Un comportement
- Nom clair : `test_<functionality>_<scenario>()`

**Exemples** :

```python
# ‚úÖ Bon : Test unitaire isol√©
def test_hash_password():
    """Test password hashing."""
    password = 'testpassword123'
    hashed = hash_password(password)
    
    assert hashed != password
    assert verify_password(password, hashed) is True
    assert verify_password('wrong', hashed) is False

# ‚úÖ Bon : Test avec mock
@patch('web.services.api_client.requests.get')
def test_fetch_external_data(mock_get):
    """Test fetching data from external API."""
    mock_get.return_value.json.return_value = {'data': 'test'}
    
    result = fetch_external_data('test-url')
    
    assert result == {'data': 'test'}
    mock_get.assert_called_once_with('test-url')
```

```javascript
// ‚úÖ Bon : Test composant isol√©
describe('ReleaseCard', () => {
  it('should render release name', () => {
    const release = { id: 1, name: 'Test Release' };
    render(<ReleaseCard release={release} />);
    
    expect(screen.getByText('Test Release')).toBeInTheDocument();
  });
  
  it('should call onEdit when edit button clicked', () => {
    const onEdit = jest.fn();
    const release = { id: 1, name: 'Test Release' };
    
    render(<ReleaseCard release={release} onEdit={onEdit} />);
    fireEvent.click(screen.getByText('Edit'));
    
    expect(onEdit).toHaveBeenCalledWith(1);
  });
});
```

---

### 2. Tests d'Int√©gration (20% du total)

**Objectif** : Tester interactions entre composants

**Exigences** :
- Ex√©cution < 5s par test
- Base de donn√©es test isol√©e
- Nettoyage apr√®s chaque test
- Sc√©narios r√©alistes

**Exemples** :

```python
# ‚úÖ Bon : Test int√©gration API + DB
def test_create_user_endpoint(client, clean_db):
    """Test cr√©ation utilisateur via API."""
    user_data = {
        'username': 'newuser',
        'email': 'newuser@test.com',
        'password': 'securepass123'
    }
    
    response = client.post('/api/users', json=user_data)
    
    assert response.status_code == 201
    assert response.json['username'] == 'newuser'
    
    # V√©rifier en DB
    user = User.query.filter_by(username='newuser').first()
    assert user is not None
    assert user.check_password('securepass123') is True
```

```javascript
// ‚úÖ Bon : Test int√©gration composants
describe('ReleaseWizard', () => {
  it('should navigate through all steps', async () => {
    render(
      <ReleaseWizardProvider>
        <ReleaseWizard />
      </ReleaseWizardProvider>
    );
    
    // √âtape 1 : Groupe
    fireEvent.change(screen.getByLabelText('Group'), {
      target: { value: 'TestGroup' }
    });
    fireEvent.click(screen.getByText('Next'));
    
    // √âtape 2 : Type
    fireEvent.click(screen.getByText('EBOOK'));
    fireEvent.click(screen.getByText('Next'));
    
    // V√©rifier √©tape suivante
    expect(screen.getByText('Select Rule')).toBeInTheDocument();
  });
});
```

---

### 3. Tests E2E (10% du total)

**Objectif** : Tester flux utilisateur complets

**Exigences** :
- Ex√©cution < 30s par test
- Navigateur r√©el (Chrome/Firefox)
- Sc√©narios utilisateur complets
- Tests critiques seulement

**‚ö†Ô∏è OBLIGATOIRE** : Utiliser **Playwright MCP Tools** pour tous les tests E2E.

**Exemples** :

```python
# ‚úÖ Bon : Test E2E avec Playwright MCP
def test_create_release_complete():
    """Test cr√©ation release compl√®te via UI avec Playwright MCP."""
    # 1. Naviguer vers nouvelle release
    mcp_playwright_browser_navigate(url="http://localhost:5000/releases/new")
    
    # 2. Capturer √©tat initial
    mcp_playwright_browser_snapshot()
    
    # 3. √âtape 1 : Groupe
    mcp_playwright_browser_type(
        element="group input",
        ref="input[name='group']",
        text="TestGroup"
    )
    mcp_playwright_browser_click(
        element="Next button",
        ref="button:has-text('Next')"
    )
    
    # 4. √âtape 2 : Type
    mcp_playwright_browser_click(
        element="EBOOK button",
        ref="button:has-text('EBOOK')"
    )
    mcp_playwright_browser_click(
        element="Next button",
        ref="button:has-text('Next')"
    )
    
    # 5. ... autres √©tapes ...
    
    # 6. Valider release cr√©√©e
    mcp_playwright_browser_wait_for(text="Release created successfully")
    mcp_playwright_browser_snapshot()
    
    # 7. Screenshot pour documentation
    mcp_playwright_browser_take_screenshot(filename="release-created.png")

# ‚ùå √âviter : Playwright standard si MCP disponible
def test_create_release_complete_old_way(page):
    """Ancienne m√©thode - √† √©viter."""
    page.goto('/releases/new')
    # ...
```

---

## üõ†Ô∏è Structure et Organisation

### Structure Fichiers

```
tests/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ test_models.py
‚îÇ   ‚îú‚îÄ‚îÄ test_services.py
‚îÇ   ‚îú‚îÄ‚îÄ test_utils.py
‚îÇ   ‚îî‚îÄ‚îÄ test_validators.py
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ test_api.py
‚îÇ   ‚îú‚îÄ‚îÄ test_db.py
‚îÇ   ‚îî‚îÄ‚îÄ test_services_integration.py
‚îú‚îÄ‚îÄ e2e/
‚îÇ   ‚îú‚îÄ‚îÄ test_wizard.py
‚îÇ   ‚îú‚îÄ‚îÄ test_navigation.py
‚îÇ   ‚îî‚îÄ‚îÄ test_user_flows.py
‚îú‚îÄ‚îÄ conftest.py           # Fixtures partag√©es
‚îî‚îÄ‚îÄ fixtures/             # Donn√©es de test
    ‚îú‚îÄ‚îÄ users.json
    ‚îî‚îÄ‚îÄ releases.json
```

### Nommage

**Python** :
- Fichiers : `test_<module>.py`
- Fonctions : `test_<functionality>_<scenario>()`
- Classes : `Test<Component>`

**JavaScript** :
- Fichiers : `*.test.js` ou `*.spec.js`
- Tests : `it('should <behavior>', () => { ... })`
- Suites : `describe('<Component>', () => { ... })`

---

## üîß Fixtures et Setup

### Backend (pytest)

```python
# conftest.py
import pytest
from web.app import create_app
from web.models import db

@pytest.fixture(scope='function')
def app():
    """Create test application."""
    app = create_app('testing')
    app.config['TESTING'] = True
    app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///:memory:'
    
    with app.app_context():
        db.create_all()
        yield app
        db.drop_all()

@pytest.fixture
def client(app):
    """Test client."""
    return app.test_client()

@pytest.fixture
def auth_headers(client):
    """Authenticated headers."""
    response = client.post('/api/auth/login', json={
        'username': 'admin',
        'password': 'password'
    })
    token = response.json['access_token']
    return {'Authorization': f'Bearer {token}'}

@pytest.fixture
def sample_user(app):
    """Sample user for tests."""
    user = User(username='testuser', email='test@test.com')
    user.set_password('password')
    db.session.add(user)
    db.session.commit()
    return user
```

### Frontend (React Testing Library)

```javascript
// test-utils.js
import { render } from '@testing-library/react';
import { ThemeProvider } from '../contexts/ThemeContext';
import { AuthProvider } from '../contexts/AuthContext';

const AllTheProviders = ({ children }) => {
  return (
    <ThemeProvider>
      <AuthProvider>
        {children}
      </AuthProvider>
    </ThemeProvider>
  );
};

const customRender = (ui, options) =>
  render(ui, { wrapper: AllTheProviders, ...options });

export * from '@testing-library/react';
export { customRender as render };

// Mock API
export const mockApi = {
  get: jest.fn(),
  post: jest.fn(),
  put: jest.fn(),
  delete: jest.fn(),
};
```

---

## ‚úÖ Checklist Tests

### Avant √âcrire Code (TDD)
- [ ] Test √©crit (Red)
- [ ] Test √©choue comme attendu
- [ ] Test nomm√© clairement
- [ ] Test isol√©

### Apr√®s Impl√©mentation
- [ ] Test passe (Green)
- [ ] Couverture 100% fonction test√©e
- [ ] Pas de r√©gression (autres tests passent)
- [ ] Code refactor√© si n√©cessaire

### Avant Commit
- [ ] Tous tests passent (`pytest && npm test`)
- [ ] Couverture 100% (`pytest --cov`)
- [ ] Tests rapides (< 5s unitaires)
- [ ] Pas de tests flaky
- [ ] Fixtures propres (pas de donn√©es r√©siduelles)

---

## üö´ Anti-Patterns

### ‚ùå Tests D√©pendants
```python
# ‚ùå Mauvais : Test d√©pend d'un autre
def test_create_user():
    user = create_user()  # Test pr√©c√©dent cr√©e user

def test_delete_user():
    user = create_user()  # D√©pend de test pr√©c√©dent
    delete_user(user.id)
```

### ‚ùå Tests Non Isol√©s
```python
# ‚ùå Mauvais : Utilise DB globale
def test_create_user():
    user = User(username='test')
    db.session.add(user)  # Modifie DB globale
    # ...
```

### ‚ùå Tests Flaky
```python
# ‚ùå Mauvais : D√©pend d'ordre ex√©cution ou timing
def test_process_file():
    file = process_file('test.txt')
    assert file.status == 'completed'  # Timing peut varier
```

### ‚ùå Tests Trop G√©n√©raux
```python
# ‚ùå Mauvais : Test trop large
def test_user_crud():
    # Test create, read, update, delete tout ensemble
    pass

# ‚úÖ Bon : Tests s√©par√©s
def test_create_user():
    pass

def test_read_user():
    pass

def test_update_user():
    pass

def test_delete_user():
    pass
```

---

## üìä Coverage Requirements

### Seuils Obligatoires
- **Unitaires** : 100% fonctions/m√©thodes
- **Int√©gration** : 100% endpoints/services
- **E2E** : 100% flux critiques

### V√©rification
```bash
# Backend
pytest --cov=web --cov=src --cov-report=term --cov-report=html

# Frontend
npm test -- --coverage

# Doit afficher 100% coverage
```

---

## üîó Liens

- **TDD Methodology** : `.cursor/rules/tdd-methodology.mdc`
- **MCP Tools Guide** : `docs/MCP_TOOLS_GUIDE.md` ‚≠ê
- **Test Plan** : `docs/TEST_PLAN.md`
- **DEVBOOK** : `docs/DEVBOOK.md`

---

**Derni√®re mise √† jour** : 2025-11-01  
**Version** : 1.0.0
