---
description: Standards Git/GitHub workflow et Conventional Commits pour eBook Scene Packer v2
globs: ["**/*"]
alwaysApply: true
---

# Workflow Git/GitHub - eBook Scene Packer v2

## üéØ Principes Fondamentaux

**Ce projet suit strictement** :
- ‚úÖ **Conventional Commits** pour tous les commits
- ‚úÖ **GitHub Flow** pour la strat√©gie de branching (simple et rapide)
- ‚úÖ **Semantic Versioning** (MAJOR.MINOR.PATCH)
- ‚úÖ **Pull Requests** obligatoires pour merge dans main
- ‚úÖ **Definition of Done** : Aucun commit sans tests passants et coverage ‚â•90%

---

## üìù Conventional Commits

### Format Standard

**Structure** : `<type>[optional scope]: <description>`

```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

### Types de Commits Autoris√©s

| Type | Description | SemVer | Exemple |
|------|-------------|--------|---------|
| `feat` | Nouvelle fonctionnalit√© | **MINOR** | `feat(wizard): add step 5 file analysis` |
| `fix` | Correction de bug | **PATCH** | `fix(api): correct validation error` |
| `docs` | Documentation uniquement | - | `docs: update DEVBOOK Phase 1` |
| `style` | Formatage, espaces, virgules | - | `style: format code with black` |
| `refactor` | Refactoring sans changement fonctionnel | - | `refactor(services): simplify packaging logic` |
| `perf` | Am√©lioration de performance | **PATCH** | `perf(db): optimize query with index` |
| `test` | Ajout/modification de tests | - | `test(wizard): add E2E test step 5` |
| `build` | Syst√®me de build | - | `build: update requirements.txt` |
| `ci` | CI/CD (GitHub Actions) | - | `ci: add maintenance check workflow` |
| `chore` | Maintenance, d√©pendances | - | `chore: upgrade Flask to 3.0.1` |

### Breaking Changes

**Deux fa√ßons de signaler un breaking change** :

1. **Avec `!` apr√®s le type** :
   ```
   feat(api)!: change response format to JSON:API spec
   ```

2. **Avec footer BREAKING CHANGE** :
   ```
   feat(api): add new authentication system

   BREAKING CHANGE: Old auth tokens are no longer valid
   ```

**Impact SemVer** : **MAJOR** version bump (ex: 2.0.0 ‚Üí 3.0.0)

### Scope (Optionnel)

**Contexte additionnel entre parenth√®ses** pour pr√©ciser la zone concern√©e :

**Scopes recommand√©s pour ce projet** :
- `wizard` : Wizard 9 √©tapes
- `api` : Endpoints API Flask
- `auth` : Authentification JWT
- `db` : Base de donn√©es, migrations
- `models` : Mod√®les SQLAlchemy
- `services` : Services m√©tier
- `frontend` : Composants React/TypeScript
- `tests` : Tests (unitaires, int√©gration, E2E)
- `docs` : Documentation
- `ci` : GitHub Actions, CI/CD
- `deps` : D√©pendances

**Exemples avec scope** :
```
feat(wizard): add step 3 rule selection
fix(api): correct validation in release endpoint
test(wizard): add E2E test for complete flow
docs(DEVBOOK): mark Phase 1 as completed
refactor(services): extract packaging logic
```

### Exemples Concrets pour ce Projet

**‚úÖ Bons exemples** :
```bash
feat(wizard): add step 5 file analysis with progress bar
fix(auth): correct JWT token refresh logic
test(wizard): add Playwright MCP E2E test step 1-3
docs(PRD-002): update wizard 9 steps specifications
refactor(services): simplify PackagingService interface
perf(db): add index on users.username column
chore(deps): upgrade Flask-SQLAlchemy to 3.1.1
ci(maintenance): add weekly audit-documentation workflow
feat(api)!: change release response format to JSON:API
```

**‚ùå Mauvais exemples** :
```bash
# ‚ùå Trop vague
fix: bug fix
update: changed code
work: progress on wizard

# ‚ùå Pas de format standard
feat: wizard step 5
fix wizard step 3
```

---

## üåø Strat√©gie de Branching : GitHub Flow

### Branches Principales

- **`main`** : Branche de production, toujours d√©ployable
  - Protection activ√©e (PR obligatoire, tests CI)
  - Historique lin√©aire requis (squash merge recommand√©)
- **`develop`** : (Optionnel) Branche d'int√©gration si besoin

### Branches de Fonctionnalit√©s

**Convention de nommage** :
- `feature/<nom-fonctionnalit√©>` : Nouvelles fonctionnalit√©s
- `fix/<nom-bug>` : Corrections de bugs
- `refactor/<nom-refactoring>` : Refactorings

**Exemples** :
```bash
feature/wizard-step-5-analysis
fix/auth-token-refresh
refactor/packaging-service
feature/frontend-react-setup
```

### Workflow Complet

**1. Cr√©er branche depuis main** :
```bash
git checkout main
git pull origin main
git checkout -b feature/wizard-step-5-analysis
```

**2. Commits fr√©quents** :
```bash
# Suivre Conventional Commits
git commit -m "feat(wizard): add step 5 file analysis UI"
git commit -m "test(wizard): add unit test for file validation"
git commit -m "docs(PRD-002): update step 5 specifications"
```

**3. Push r√©gulier** :
```bash
git push origin feature/wizard-step-5-analysis
# Ou avec tracking la premi√®re fois
git push -u origin feature/wizard-step-5-analysis
```

**4. Ouvrir Pull Request** :
```bash
# Avec GitHub CLI
gh pr create --title "feat(wizard): add step 5 file analysis" \
  --body "Fixes #123" \
  --label "enhancement" \
  --assignee @me

# Ou via GitHub web interface
```

**5. Review + Tests CI** :
- ‚úÖ Tous les tests doivent passer
- ‚úÖ Coverage ‚â•90% (v√©rifi√© automatiquement)
- ‚úÖ Linters passent (ruff, eslint)
- ‚úÖ Minimum 1 approbation requise
- ‚úÖ R√©solution de tous les commentaires

**6. Merge dans main** :
```bash
# Squash and merge recommand√© pour historique propre
gh pr merge --squash

# Ou via GitHub web interface : "Squash and merge"
```

**7. Suppression branche** :
```bash
# Automatique apr√®s merge si configur√©
# Ou manuellement :
git branch -d feature/wizard-step-5-analysis
git push origin --delete feature/wizard-step-5-analysis
```

### Rebase vs Merge

**‚úÖ Rebase LOCAL uniquement** :
```bash
# Sur branche locale avant PR
git checkout feature/my-feature
git rebase main  # Nettoyer historique

# Push force (seulement si branche non partag√©e)
git push --force-with-lease origin feature/my-feature
```

**‚ùå JAMAIS rebase sur branches partag√©es** :
- Ne jamais rebase une branche d√©j√† pouss√©e si d'autres personnes y travaillent
- Utiliser merge pour int√©gration dans main

**Workflow recommand√©** :
```bash
# 1. Rebase local pour nettoyer
git rebase main

# 2. Merge dans main (via PR)
# GitHub : "Squash and merge" pour historique lin√©aire
```

---

## üîÑ Pull Requests

### Avant de Cr√©er une PR

**Checklist obligatoire** :
```bash
# 1. Rebase sur main
git checkout feature/my-feature
git fetch origin
git rebase origin/main

# 2. Tous les tests passent localement
source venv/bin/activate
pytest tests/ -v --cov=web --cov=src --cov-report=term

# 3. Code lint sans erreurs
ruff check web/ src/
# (eslint pour frontend quand cr√©√©)

# 4. Documentation √† jour
# - DEVBOOK.md si √©tape compl√©t√©e
# - PRDs si fonctionnalit√© modifi√©e
./scripts/verify-consistency.sh
```

### Format de PR

**Titre** : Suivre Conventional Commits
```
feat(wizard): add step 5 file analysis
fix(api): correct release validation
docs(DEVBOOK): mark Phase 1 as completed
```

**Description** : Utiliser template (si cr√©√©)
```markdown
## Description
Ajout de l'√©tape 5 du wizard : analyse de fichier avec barre de progression.

## Type de changement
- [x] New feature (MINOR)

## Tests effectu√©s
- Tests unitaires : ‚úÖ 15/15 passent
- Tests E2E : ‚úÖ Playwright MCP test passe
- Coverage : ‚úÖ 95%

## Checklist
- [x] Code suit les conventions du projet
- [x] Documentation √† jour (DEVBOOK)
- [x] Tests passent (100%)
- [x] Coverage ‚â•90% (95%)
- [x] Commits suivent Conventional Commits

## Issues li√©es
Closes #123
Relates to PRD-002
```

### Commandes GH CLI Utiles

```bash
# Cr√©er PR avec pr√©-remplissage
gh pr create --fill

# Lister mes PRs ouvertes
gh pr list --author @me --state open

# Review automatique
gh pr review --approve
gh pr review --comment --body "LGTM! ‚úÖ"

# Merge avec squash
gh pr merge --squash

# Fermer PR
gh pr close <number>
```

---

## üè∑Ô∏è Semantic Versioning

### Format MAJOR.MINOR.PATCH

Le projet utilise **SemVer** strictement :

- **MAJOR** (2.0.0 ‚Üí 3.0.0) : Breaking changes
  - `feat(api)!: change response format`
  - `BREAKING CHANGE:` dans footer

- **MINOR** (2.0.0 ‚Üí 2.1.0) : Nouvelles fonctionnalit√©s compatibles
  - `feat(wizard): add step 5`
  - `feat(api): add new endpoint`

- **PATCH** (2.0.0 ‚Üí 2.0.1) : Corrections de bugs compatibles
  - `fix(auth): correct token refresh`
  - `perf(db): optimize query`

### R√®gles de Versioning

1. **Version 0.y.z** pour d√©veloppement initial (Phase 0)
2. **1.0.0** d√©finit l'API publique (quand production-ready)
3. **Incr√©menter MAJOR** pour breaking changes
4. **Incr√©menter MINOR** pour ajouts r√©trocompatibles
5. **Incr√©menter PATCH** pour corrections r√©trocompatibles
6. **Une fois publi√©, un num√©ro ne doit JAMAIS √™tre modifi√©**

### Versioning Actuel

**Version actuelle** : **2.0.0** (refonte compl√®te v2)

**Historique** :
- `v1.x.x` : Version pr√©c√©dente (dans `v1/`)
- `2.0.0` : D√©but v2 (Phase 0 compl√©t√©e)

### Automatisation (Futur)

Quand projet sera pr√™t pour releases automatiques :
- Utiliser `semantic-release` (adapt√© pour Python si n√©cessaire)
- GitHub Actions workflow pour versioning automatique
- G√©n√©ration CHANGELOG.md automatique

---

## üîß Configuration Pre-commit (Recommand√©)

### Pour Python (Flask)

**Installation** :
```bash
pip install pre-commit
pre-commit install
```

**Configuration `.pre-commit-config.yaml`** :
```yaml
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
      - id: check-added-large-files
      - id: check-json
      - id: check-toml
      
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.9
    hooks:
      - id: ruff
        args: [--fix]
      - id: ruff-format
        
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.7.1
    hooks:
      - id: mypy
        additional_dependencies: [types-all]
```

**Validation Conventional Commits** :
```yaml
  - repo: https://github.com/commitizen-tools/commitizen
    rev: v3.13.0
    hooks:
      - id: commitizen
```

### Pour Frontend React/TypeScript (Quand cr√©√©)

**Installation** :
```bash
npm install --save-dev husky @commitlint/cli @commitlint/config-conventional lint-staged
npx husky init
```

**Configuration `commitlint.config.js`** :
```javascript
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [
      2,
      'always',
      ['feat', 'fix', 'docs', 'style', 'refactor', 'perf', 'test', 'build', 'ci', 'chore']
    ],
    'scope-case': [2, 'always', 'kebab-case'],
    'subject-max-length': [2, 'always', 100],
  },
};
```

**Configuration `lint-staged`** :
```json
{
  "lint-staged": {
    "*.{ts,tsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "*.{json,md}": [
      "prettier --write"
    ]
  }
}
```

---

## üîê Protection des Branches

### Configuration Recommand√©e pour `main`

**GitHub Settings > Branches > Branch protection rules** :

‚úÖ **Require pull request reviews before merging**
   - Required approving reviews: **1** (minimum)
   - Dismiss stale pull request approvals when new commits are pushed
   - Require review from Code Owners (si CODEOWNERS configur√©)

‚úÖ **Require status checks to pass before merging**
   - Require branches to be up to date before merging
   - Status checks :
     - ‚úÖ `CI / test` (pytest)
     - ‚úÖ `CI / coverage` (coverage ‚â•90%)
     - ‚úÖ `CI / lint` (ruff, eslint)

‚úÖ **Require conversation resolution before merging**

‚úÖ **Require signed commits** (optionnel, selon politique s√©curit√©)

‚úÖ **Require linear history**
   - Pas de merge commits directs
   - Squash merge recommand√©

‚úÖ **Include administrators**
   - Appliquer les r√®gles m√™me aux admins

‚úÖ **Restrict who can push to matching branches**
   - Restricted to: Maintainers team (si √©quipe)

‚ùå **Allow force pushes** : **Never**

‚ùå **Allow deletions** : **Never**

---

## üöÄ GitHub Actions

### Workflows Actuels (√Ä Cr√©er)

#### 1. CI Workflow (`.github/workflows/ci.yml`)

```yaml
name: CI - Tests & Lint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      
      - name: Run tests with coverage
        run: |
          pytest tests/ -v --cov=web --cov=src --cov-report=xml --cov-report=term
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
      
      - name: Check coverage threshold
        run: |
          coverage report --fail-under=90
      
      - name: Lint with ruff
        run: |
          ruff check web/ src/
          ruff format --check web/ src/
```

#### 2. Maintenance Check (`.github/workflows/maintenance-check.yml`)

```yaml
name: Maintenance Check

on:
  schedule:
    - cron: '0 9 * * 1'  # Tous les lundis 9h
  workflow_dispatch:

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Audit Documentation
        run: ./scripts/audit-documentation.sh
        continue-on-error: true
      
      - name: Verify Consistency
        run: ./scripts/verify-consistency.sh
        continue-on-error: true
      
      - name: Cleanup Code (Check)
        run: ./scripts/cleanup-code.sh
        continue-on-error: true
```

### S√©curit√© Workflows

**R√®gles critiques** :
1. ‚úÖ **Permissions read-only par d√©faut** pour `GITHUB_TOKEN`
2. ‚úÖ **Versions √©pingl√©es** avec SHA complet pour actions tierces
3. ‚úÖ **Ne jamais stocker secrets en clair**
4. ‚úÖ **√âviter `pull_request_target`** avec code non v√©rifi√©

**Exemple permissions minimales** :
```yaml
permissions:
  contents: read
  pull-requests: write
  checks: write
```

---

## üìã Templates GitHub

### Pull Request Template (`.github/PULL_REQUEST_TEMPLATE.md`)

```markdown
## Description

<!-- Description claire des changements -->

## Type de changement

- [ ] Bug fix (PATCH)
- [ ] New feature (MINOR)
- [ ] Breaking change (MAJOR)
- [ ] Documentation update
- [ ] Refactoring
- [ ] Performance improvement

## Tests effectu√©s

<!-- Comment les changements ont √©t√© test√©s -->
- [ ] Tests unitaires : X/X passent
- [ ] Tests int√©gration : X/X passent
- [ ] Tests E2E : X/X passent
- [ ] Coverage : XX% (‚â•90% requis)

## Checklist

- [ ] Mon code suit les conventions du projet
- [ ] J'ai effectu√© une auto-review
- [ ] J'ai comment√© les parties complexes
- [ ] La documentation est √† jour (DEVBOOK si √©tape compl√©t√©e)
- [ ] Mes changements ne g√©n√®rent pas de warnings
- [ ] J'ai ajout√© des tests qui prouvent mon fix/feature
- [ ] Tous les tests passent localement
- [ ] Les commits suivent Conventional Commits
- [ ] Coverage ‚â•90% v√©rifi√©
- [ ] Linters passent (ruff, eslint)

## Issues li√©es

Closes #(issue)

Relates to PRD-XXX

## Screenshots (si UI)

<!-- Pour changements frontend -->
```

### Issue Templates (`.github/ISSUE_TEMPLATE/bug_report.yml`)

```yaml
name: Bug Report
description: Signaler un bug
title: "[BUG]: "
labels: ["bug", "triage"]

body:
  - type: markdown
    attributes:
      value: |
        Merci de remplir ce formulaire avec le maximum de d√©tails.
        
  - type: textarea
    id: description
    attributes:
      label: Description du bug
      description: Description claire et concise
      placeholder: Le bug se produit quand...
    validations:
      required: true
      
  - type: textarea
    id: reproduction
    attributes:
      label: √âtapes de reproduction
      description: Comment reproduire le comportement
      placeholder: |
        1. Aller √† '...'
        2. Cliquer sur '...'
        3. Voir l'erreur
    validations:
      required: true
      
  - type: textarea
    id: expected
    attributes:
      label: Comportement attendu
      description: Ce qui devrait se passer
    validations:
      required: true
      
  - type: textarea
    id: environment
    attributes:
      label: Environnement
      description: OS, Python version, etc.
      placeholder: |
        - OS: Linux Debian 12
        - Python: 3.11
        - Browser: Chrome 120
```

---

## üîß GitHub CLI - Aliases Utiles

### Configuration Aliases

```bash
# Aliases recommand√©s pour ce projet
gh alias set prc 'pr create --fill'
gh alias set mywork 'pr list --author @me --state open'
gh alias set myissues 'issue list --author @me --state open'
gh alias set review 'pr review --approve'
gh alias set wizard 'pr create --title "feat(wizard):" --body "Wizard enhancement"'
gh alias set fix 'pr create --title "fix:" --body "Bug fix"'
```

### Commandes Utiles

```bash
# Cr√©er PR rapidement
gh prc

# Lister mes PRs en cours
gh mywork

# Review et merge
gh pr review <number> --approve
gh pr merge <number> --squash

# Cr√©er issue
gh issue create --title "[BUG]: " --body "Description"

# Lister issues
gh issue list --label "bug" --state open
```

---

## ‚úÖ Checklist Avant Commit

### Obligatoire

- [ ] **Conventional Commits** : Format `<type>[scope]: <description>`
- [ ] **Tests passent** : `pytest tests/ -v`
- [ ] **Coverage ‚â•90%** : `pytest --cov` (v√©rifi√© automatiquement)
- [ ] **Linters passent** : `ruff check`, `eslint` (si frontend)
- [ ] **Documentation √† jour** : DEVBOOK, PRDs si √©tape compl√©t√©e
- [ ] **Pas de secrets** : Aucun mot de passe/API key en clair
- [ ] **Code propre** : Pas de code mort, imports non utilis√©s

### Recommand√©

- [ ] **Rebase local** : `git rebase main` (si branche locale)
- [ ] **V√©rification coh√©rence** : `./scripts/verify-consistency.sh`
- [ ] **Messages clairs** : Description explicite du changement

---

## üö® Anti-Patterns √† √âviter

### ‚ùå Mauvaises Pratiques Git

```bash
# ‚ùå Commits vagues
git commit -m "update"
git commit -m "fix"
git commit -m "changes"

# ‚ùå Commits trop gros (plusieurs fonctionnalit√©s)
git commit -m "feat: add wizard and fix auth and update docs"

# ‚ùå Force push sur branches partag√©es
git push --force origin main  # JAMAIS!

# ‚ùå Merge direct dans main sans PR
git checkout main
git merge feature/my-feature  # Utiliser PR √† la place
```

### ‚úÖ Bonnes Pratiques

```bash
# ‚úÖ Commits atomiques et descriptifs
git commit -m "feat(wizard): add step 5 file analysis UI"
git commit -m "test(wizard): add unit test for file validation"

# ‚úÖ Rebase local seulement
git rebase main  # Sur branche locale avant PR

# ‚úÖ Pull Request obligatoire
gh pr create --fill
```

---

## üìö Ressources et Documentation

### Documentation Officielle

- **Conventional Commits** : https://www.conventionalcommits.org
- **GitHub Flow** : https://docs.github.com/en/get-started/quickstart/github-flow
- **Semantic Versioning** : https://semver.org
- **GitHub CLI** : https://cli.github.com/manual/
- **Pre-commit** : https://pre-commit.com

### Documentation Projet

- **DEVBOOK** : `docs/DEVBOOK.md` - Suivi phases/√©tapes
- **Definition of Done** : `.cursor/rules/definition-of-done.mdc`
- **Maintenance Guide** : `docs/MAINTENANCE_GUIDE.md`

---

## üéØ R√®gles Sp√©cifiques Projet

### Commits et Documentation

**R√®gle stricte** : **JAMAIS committer si documentation non √† jour**

**Si √©tape compl√©t√©e** :
```bash
# 1. Mettre √† jour DEVBOOK.md
# 2. Mettre √† jour todolist.md
# 3. V√©rifier coh√©rence
./scripts/verify-consistency.sh

# 4. Puis committer
git commit -m "docs(DEVBOOK): mark Phase 1.1 as completed"
```

### Tests Obligatoires

**Avant chaque commit de code** :
```bash
# Tests doivent passer √† 100%
pytest tests/ -v

# Coverage ‚â•90% requis
pytest --cov=web --cov=src --cov-report=term
```

### Pull Request Workflow

**Workflow obligatoire** :
1. ‚úÖ Cr√©er branche depuis main
2. ‚úÖ D√©velopper avec commits Conventional Commits
3. ‚úÖ Tous les tests passent localement
4. ‚úÖ Documentation √† jour (si √©tape compl√©t√©e)
5. ‚úÖ Ouvrir Pull Request
6. ‚úÖ CI/CD doit √™tre vert
7. ‚úÖ Review + approbation
8. ‚úÖ Merge avec squash

---

**Derni√®re mise √† jour** : 2025-11-01  
**Version** : 1.0.0  
**Priorit√©** : CRITIQUE ‚ö†Ô∏è

**Rappel** : Cette r√®gle est **toujours active** (`alwaysApply: true`) pour garantir des commits propres et un workflow Git optimal.
