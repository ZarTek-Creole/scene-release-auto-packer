openapi: 3.0.3
info:
  title: eBook Scene Packer v2 API
  description: |
    API REST complète pour eBook Scene Packer v2 permettant la création, gestion et packaging de releases Scene (EBOOK, TV, DOCS, etc.) avec système de permissions granulaires, gestion des rules, utilisateurs, rôles et configurations.
    
    **Authentification** : Tous les endpoints (sauf `/auth/login`) requièrent un JWT Bearer Token dans le header `Authorization`.
    
    **Permissions** : Les endpoints vérifient les permissions READ/WRITE/MOD/DELETE selon la ressource et l'action.
  version: 1.0.0
  contact:
    name: Dev Team
    email: dev@example.com
  license:
    name: Proprietary

servers:
  - url: http://localhost:5000/api
    description: Développement local
  - url: https://api.example.com/api
    description: Production (exemple)

tags:
  - name: Authentication
    description: Authentification et gestion des tokens JWT
  - name: Dashboard
    description: Statistiques et informations dashboard
  - name: Wizard
    description: Wizard 9 étapes pour création release
  - name: Releases
    description: Gestion des releases créées
  - name: Rules
    description: Gestion des rules Scene (locales et scenerules.org)
  - name: Users
    description: Gestion des utilisateurs (admin uniquement)
  - name: Roles
    description: Gestion des rôles et permissions (admin uniquement)
  - name: Configurations
    description: Configuration système, APIs, destinations FTP/SSH (admin uniquement)

security:
  - bearerAuth: []

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT Access Token obtenu via `/auth/login`.
        
        **Format** : `Authorization: Bearer <access_token>`
        
        **Durée de vie** : 15 minutes
        
        **Refresh** : Utiliser `/auth/refresh` avec refresh_token

  schemas:
    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          example: ValidationError
        message:
          type: string
          example: Invalid input
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          example:
            username: ["Username is required"]

    Pagination:
      type: object
      properties:
        page:
          type: integer
          example: 1
        per_page:
          type: integer
          example: 20
        total:
          type: integer
          example: 150
        pages:
          type: integer
          example: 8

    User:
      type: object
      properties:
        id:
          type: integer
          example: 1
        username:
          type: string
          example: operator
        email:
          type: string
          format: email
          example: operator@example.com
        note:
          type: string
          nullable: true
          example: Operator account
        active:
          type: boolean
          example: true
        roles:
          type: array
          items:
            type: string
          example: ["Operator"]
        groups:
          type: array
          items:
            type: string
          example: ["TESTGROUP"]
        permissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          example:
            releases: ["READ", "WRITE"]
            rules: ["READ", "WRITE"]
        created_at:
          type: string
          format: date-time
          example: "2025-11-01T10:00:00Z"

    Release:
      type: object
      properties:
        id:
          type: integer
          example: 1
        group:
          type: string
          example: TESTGROUP
        type:
          type: string
          enum: [EBOOK, TV, DOCS, AUDIOBOOK, GAME]
          example: EBOOK
        status:
          type: string
          enum: [draft, completed, failed]
          example: completed
        metadata:
          type: object
          additionalProperties: true
          example:
            title: "Example Book"
            author: "John Doe"
            isbn: "1234567890"
        config:
          type: object
          additionalProperties: true
          example:
            format: "ZIP"
            volumes: 50
        file_path:
          type: string
          nullable: true
          example: "/releases/testgroup-example-book.epub"
        created_at:
          type: string
          format: date-time
          example: "2025-11-01T10:00:00Z"
        user:
          type: object
          properties:
            id:
              type: integer
            username:
              type: string

    Job:
      type: object
      properties:
        id:
          type: integer
          example: 124
        release_id:
          type: integer
          nullable: true
          example: 1
        status:
          type: string
          enum: [pending, running, completed, failed]
          example: completed
        config_json:
          type: object
          additionalProperties: true
          nullable: true
        logs:
          type: string
          nullable: true
          example: "Packaging started...\nFile analyzed..."
        created_at:
          type: string
          format: date-time
          example: "2025-11-01T10:00:00Z"
        created_by:
          type: integer
          example: 1

    Rule:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: eBOOK-2024
        content:
          type: string
          example: "Title: {{title}}\nAuthor: {{author}}\n..."
        scene:
          type: string
          nullable: true
          example: English
        section:
          type: string
          nullable: true
          example: eBOOK
        year:
          type: integer
          nullable: true
          example: 2024
        created_at:
          type: string
          format: date-time
          example: "2025-11-01T10:00:00Z"
        updated_at:
          type: string
          format: date-time
          nullable: true

    Role:
      type: object
      properties:
        id:
          type: integer
          example: 1
        name:
          type: string
          example: Admin
        description:
          type: string
          nullable: true
          example: "Administrateur avec accès complet"
        permissions:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          example:
            releases: ["READ", "WRITE", "MOD", "DELETE"]
        users_count:
          type: integer
          example: 2
        created_at:
          type: string
          format: date-time

paths:
  /auth/login:
    post:
      tags:
        - Authentication
      security: []
      summary: Connexion utilisateur
      description: Authentification et obtention tokens JWT (access + refresh)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: operator
                password:
                  type: string
                  format: password
                  example: securepassword123
      responses:
        '200':
          description: Connexion réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
                    example: eyJ0eXAiOiJKV1QiLCJhbGc...
                  refresh_token:
                    type: string
                    example: eyJ0eXAiOiJKV1QiLCJhbGc...
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: Credentials invalides
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: Unauthorized
                message: Invalid username or password

  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Rafraîchir access token
      description: Obtenir un nouveau access token avec refresh token
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Token rafraîchi
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
        '401':
          description: Refresh token invalide/expiré
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Déconnexion
      description: Invalidation refresh token
      responses:
        '200':
          description: Déconnexion réussie
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Logout successful

  /auth/me:
    get:
      tags:
        - Authentication
      summary: Informations utilisateur connecté
      description: Récupérer informations utilisateur depuis token JWT
      responses:
        '200':
          description: Informations utilisateur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  /dashboard/stats:
    get:
      tags:
        - Dashboard
      summary: Statistiques dashboard
      description: Statistiques globales et par utilisateur
      responses:
        '200':
          description: Statistiques
          content:
            application/json:
              schema:
                type: object
                properties:
                  releases_count:
                    type: integer
                    example: 150
                  my_releases_count:
                    type: integer
                    example: 25
                  releases_by_type:
                    type: object
                    additionalProperties:
                      type: integer
                    example:
                      EBOOK: 100
                      TV: 40
                      DOCS: 10
                  recent_releases:
                    type: array
                    items:
                      $ref: '#/components/schemas/Release'

  /wizard/step/{step}/validate:
    post:
      tags:
        - Wizard
      summary: Valider étape wizard
      description: Valider données étape wizard (1-9)
      parameters:
        - name: step
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 9
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Données dépendantes de l'étape
              example:
                group: TESTGROUP
      responses:
        '200':
          description: Validation résultat
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  errors:
                    type: array
                    items:
                      type: string

  /wizard/step/{step}/save:
    post:
      tags:
        - Wizard
      summary: Sauvegarder progression étape
      description: Sauvegarder progression étape dans backend (Job draft)
      parameters:
        - name: step
          in: path
          required: true
          schema:
            type: integer
            minimum: 1
            maximum: 9
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  type: object
                  additionalProperties: true
      responses:
        '200':
          description: Progression sauvegardée
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: integer
                  message:
                    type: string

  /wizard/step/{step}/data:
    get:
      tags:
        - Wizard
      summary: Récupérer données étape
      description: Récupérer données étape sauvegardée
      parameters:
        - name: step
          in: path
          required: true
          schema:
            type: integer
        - name: job_id
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Données étape
          content:
            application/json:
              schema:
                type: object
                properties:
                  step:
                    type: integer
                  data:
                    type: object
                    additionalProperties: true

  /wizard/pack:
    post:
      tags:
        - Wizard
      summary: Lancer packaging
      description: Lancer packaging release (étape 8)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - job_id
              properties:
                job_id:
                  type: integer
                options:
                  type: object
                  properties:
                    format:
                      type: string
                      enum: [ZIP, RAR, BOTH]
                    compression:
                      type: string
                    volumes:
                      type: integer
                    generate_nfo:
                      type: boolean
                    generate_diz:
                      type: boolean
                    generate_sfv:
                      type: boolean
      responses:
        '200':
          description: Packaging démarré
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: integer
                  status:
                    type: string
                  message:
                    type: string

  /wizard/jobs/{job_id}/status:
    get:
      tags:
        - Wizard
      summary: Statut job packaging
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Statut job
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Job'

  /wizard/jobs/{job_id}/logs:
    get:
      tags:
        - Wizard
      summary: Logs job temps réel
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
        - name: since
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Logs job
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      type: object
                      properties:
                        timestamp:
                          type: string
                          format: date-time
                        level:
                          type: string
                        message:
                          type: string

  /wizard/jobs/{job_id}/analysis:
    get:
      tags:
        - Wizard
      summary: Résultats analyse fichier
      parameters:
        - name: job_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Résultats analyse
          content:
            application/json:
              schema:
                type: object
                properties:
                  metadata:
                    type: object
                    additionalProperties: true
                  mediainfo:
                    type: object
                    additionalProperties: true
                  structure:
                    type: object
                    additionalProperties: true

  /wizard/step/5/analyze:
    post:
      tags:
        - Wizard
      summary: Lancer analyse fichier
      description: Lancer analyse asynchrone fichier (étape 5)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - file_path
                - release_type
              properties:
                file_path:
                  type: string
                release_type:
                  type: string
      responses:
        '202':
          description: Analyse démarrée (asynchrone)
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: integer
                  status:
                    type: string

  /wizard/step/6/enrich:
    post:
      tags:
        - Wizard
      summary: Enrichir métadonnées
      description: Enrichir métadonnées avec APIs externes (étape 6)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                metadata:
                  type: object
                release_type:
                  type: string
                api_priority:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: Métadonnées enrichies
          content:
            application/json:
              schema:
                type: object
                properties:
                  enriched:
                    type: object
                  sources:
                    type: object

  /wizard/step/7/render:
    post:
      tags:
        - Wizard
      summary: Rendu prévisualisation template
      description: Générer prévisualisation NFO depuis template (étape 7)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                template_id:
                  type: integer
                metadata:
                  type: object
      responses:
        '200':
          description: Prévisualisation générée
          content:
            application/json:
              schema:
                type: object
                properties:
                  preview:
                    type: string

  /releases:
    get:
      tags:
        - Releases
      summary: Liste releases
      description: Liste releases avec filtres, recherche et pagination
      parameters:
        - name: type
          in: query
          schema:
            type: array
            items:
              type: string
              enum: [EBOOK, TV, DOCS, AUDIOBOOK, GAME]
        - name: group
          in: query
          schema:
            type: array
            items:
              type: string
        - name: status
          in: query
          schema:
            type: array
            items:
              type: string
              enum: [draft, completed, failed]
        - name: search
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: sort
          in: query
          schema:
            type: string
            enum: [created_at, name, size]
            default: created_at
        - name: order
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
        - name: my_only
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Liste releases
          content:
            application/json:
              schema:
                type: object
                properties:
                  releases:
                    type: array
                    items:
                      $ref: '#/components/schemas/Release'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /releases/{id}:
    get:
      tags:
        - Releases
      summary: Détail release
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Détail release
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Release'
        '404':
          description: Release non trouvée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      tags:
        - Releases
      summary: Édition release
      description: Modifier release (permission WRITE requise)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                metadata:
                  type: object
                config:
                  type: object
      responses:
        '200':
          description: Release modifiée
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  message:
                    type: string
        '403':
          description: Permission WRITE manquante
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Releases
      summary: Suppression release
      description: Supprimer release (admin uniquement)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Release supprimée
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /releases/{id}/repack:
    post:
      tags:
        - Releases
      summary: Repackaging release
      description: Repackager release (permission MOD requise)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                options:
                  type: object
      responses:
        '200':
          description: Repackaging démarré
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: integer
                  status:
                    type: string

  /releases/{id}/nfofix:
    post:
      tags:
        - Releases
      summary: Correction NFO
      description: Corriger fichier NFO release (permission MOD requise)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: NFO corrigé
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  changes:
                    type: array
                    items:
                      type: string

  /releases/{id}/readnfo:
    post:
      tags:
        - Releases
      summary: Régénération depuis NFO
      description: Régénérer release depuis NFO existant (permission MOD requise)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Régénération démarrée
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: integer
                  status:
                    type: string

  /releases/{id}/dirfix:
    post:
      tags:
        - Releases
      summary: Correction structure répertoires
      description: Corriger structure répertoires release (permission MOD requise)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Structure corrigée
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  changes:
                    type: array
                    items:
                      type: string

  /releases/{id}/files:
    get:
      tags:
        - Releases
      summary: Arborescence fichiers
      description: Liste fichiers release
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Arborescence fichiers
          content:
            application/json:
              schema:
                type: object
                properties:
                  files:
                    type: array
                    items:
                      type: object
                      properties:
                        path:
                          type: string
                        size:
                          type: integer
                        type:
                          type: string
                          enum: [file, directory]

  /releases/{id}/jobs:
    get:
      tags:
        - Releases
      summary: Historique jobs
      description: Liste jobs associés à release
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Historique jobs
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobs:
                    type: array
                    items:
                      $ref: '#/components/schemas/Job'

  /rules:
    get:
      tags:
        - Rules
      summary: Liste rules locales
      description: Liste rules locales avec filtres et recherche
      parameters:
        - name: scene
          in: query
          schema:
            type: string
        - name: section
          in: query
          schema:
            type: string
        - name: year
          in: query
          schema:
            type: integer
        - name: type
          in: query
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Liste rules
          content:
            application/json:
              schema:
                type: object
                properties:
                  rules:
                    type: array
                    items:
                      $ref: '#/components/schemas/Rule'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

  /rules/local:
    get:
      tags:
        - Rules
      summary: Liste rules locales uniquement
      description: Identique à /rules mais explicite
      parameters:
        - name: scene
          in: query
          schema:
            type: string
        - name: section
          in: query
          schema:
            type: string
        - name: year
          in: query
          schema:
            type: integer
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Liste rules locales
          content:
            application/json:
              schema:
                type: object
                properties:
                  rules:
                    type: array
                    items:
                      $ref: '#/components/schemas/Rule'

  /rules/scenerules:
    get:
      tags:
        - Rules
      summary: Liste rules scenerules.org
      description: Liste rules disponibles sur scenerules.org
      parameters:
        - name: scene
          in: query
          schema:
            type: string
        - name: section
          in: query
          schema:
            type: string
        - name: year
          in: query
          schema:
            type: integer
        - name: type
          in: query
          schema:
            type: string
        - name: search
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Liste rules scenerules.org
          content:
            application/json:
              schema:
                type: object
                properties:
                  rules:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        scene:
                          type: string
                        section:
                          type: string
                        year:
                          type: integer
                        url:
                          type: string
                          format: uri
                        downloaded:
                          type: boolean

  /rules/{id}:
    get:
      tags:
        - Rules
      summary: Détail rule locale
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Détail rule
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Rule'

  /rules/{id}/preview:
    get:
      tags:
        - Rules
      summary: Prévisualisation rule
      description: Contenu rule formaté pour NFO viewer
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Prévisualisation
          content:
            application/json:
              schema:
                type: object
                properties:
                  content:
                    type: string
                  formatted:
                    type: boolean

  /rules/upload:
    post:
      tags:
        - Rules
      summary: Upload rule locale
      description: Upload rule depuis fichier local (permission WRITE requise)
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
              properties:
                file:
                  type: string
                  format: binary
                name:
                  type: string
                scene:
                  type: string
                section:
                  type: string
                year:
                  type: integer
      responses:
        '200':
          description: Rule uploadée
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  message:
                    type: string

  /rules/download:
    post:
      tags:
        - Rules
      summary: Téléchargement rule scenerules.org
      description: Télécharger rule depuis scenerules.org vers rules locales (permission WRITE requise)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                scene:
                  type: string
                section:
                  type: string
                year:
                  type: integer
      responses:
        '200':
          description: Rule téléchargée
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  message:
                    type: string

  /rules/{id}:
    put:
      tags:
        - Rules
      summary: Édition rule locale
      description: Modifier rule locale (permission MOD requise)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                content:
                  type: string
                scene:
                  type: string
                section:
                  type: string
                year:
                  type: integer
      responses:
        '200':
          description: Rule modifiée
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  message:
                    type: string

    delete:
      tags:
        - Rules
      summary: Suppression rule locale
      description: Supprimer rule locale (permission MOD requise)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Rule supprimée
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /rules/sync:
    post:
      tags:
        - Rules
      summary: Synchronisation scenerules.org
      description: Synchroniser rules depuis scenerules.org (admin uniquement, asynchrone)
      responses:
        '202':
          description: Synchronisation démarrée
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: integer
                  status:
                    type: string
                  message:
                    type: string

  /users:
    get:
      tags:
        - Users
      summary: Liste utilisateurs
      description: Liste utilisateurs (admin uniquement)
      parameters:
        - name: status
          in: query
          schema:
            type: array
            items:
              type: string
              enum: [active, inactive]
        - name: role
          in: query
          schema:
            type: array
            items:
              type: string
        - name: group
          in: query
          schema:
            type: array
            items:
              type: string
        - name: search
          in: query
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            default: 20
      responses:
        '200':
          description: Liste utilisateurs
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'
                  pagination:
                    $ref: '#/components/schemas/Pagination'

    post:
      tags:
        - Users
      summary: Création utilisateur
      description: Créer nouvel utilisateur (admin uniquement)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  minLength: 3
                  maxLength: 100
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
                  minLength: 8
                note:
                  type: string
                active:
                  type: boolean
                  default: true
      responses:
        '201':
          description: Utilisateur créé
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  username:
                    type: string
                  message:
                    type: string
        '400':
          description: Validation échouée
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Username dupliqué
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /users/{id}:
    get:
      tags:
        - Users
      summary: Détail utilisateur
      description: Détail utilisateur (admin uniquement)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Détail utilisateur
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

    put:
      tags:
        - Users
      summary: Modification utilisateur
      description: Modifier utilisateur (admin uniquement)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                  format: email
                note:
                  type: string
                password:
                  type: string
                  format: password
                active:
                  type: boolean
      responses:
        '200':
          description: Utilisateur modifié
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  message:
                    type: string

    delete:
      tags:
        - Users
      summary: Suppression utilisateur
      description: Supprimer/désactiver utilisateur (admin uniquement)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: permanent
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Utilisateur supprimé
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /users/{id}/groups:
    post:
      tags:
        - Users
      summary: Affectation groupes
      description: Affecter groupes à utilisateur (admin uniquement)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - group_ids
              properties:
                group_ids:
                  type: array
                  items:
                    type: integer
      responses:
        '200':
          description: Groupes affectés
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  groups:
                    type: array
                    items:
                      type: object

  /users/{id}/groups/{group_id}:
    delete:
      tags:
        - Users
      summary: Retrait groupe
      description: Retirer groupe de utilisateur (admin uniquement)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: group_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Groupe retiré
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /users/{id}/roles:
    post:
      tags:
        - Users
      summary: Affectation rôle
      description: Affecter rôle à utilisateur (admin uniquement)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - role_id
              properties:
                role_id:
                  type: integer
      responses:
        '200':
          description: Rôle affecté
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  role:
                    type: object

  /users/{id}/permissions:
    get:
      tags:
        - Users
      summary: Récupération permissions
      description: Récupérer permissions utilisateur (admin uniquement)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Permissions utilisateur
          content:
            application/json:
              schema:
                type: object
                properties:
                  role_permissions:
                    type: object
                  custom_permissions:
                    type: object
                  final_permissions:
                    type: object

    put:
      tags:
        - Users
      summary: Configuration permissions
      description: Configurer permissions personnalisées utilisateur (admin uniquement)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                permissions:
                  type: array
                  items:
                    type: object
                    properties:
                      resource:
                        type: string
                      action:
                        type: string
                        enum: [READ, WRITE, MOD, DELETE]
      responses:
        '200':
          description: Permissions mises à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /roles:
    get:
      tags:
        - Roles
      summary: Liste rôles
      description: Liste tous les rôles
      responses:
        '200':
          description: Liste rôles
          content:
            application/json:
              schema:
                type: object
                properties:
                  roles:
                    type: array
                    items:
                      $ref: '#/components/schemas/Role'

    post:
      tags:
        - Roles
      summary: Création rôle
      description: Créer nouveau rôle (admin uniquement)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  minLength: 3
                  maxLength: 100
                description:
                  type: string
      responses:
        '201':
          description: Rôle créé
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  message:
                    type: string

  /roles/{id}:
    get:
      tags:
        - Roles
      summary: Détail rôle
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Détail rôle
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Role'

    put:
      tags:
        - Roles
      summary: Modification rôle
      description: Modifier rôle (admin uniquement)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                description:
                  type: string
      responses:
        '200':
          description: Rôle modifié
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  message:
                    type: string

    delete:
      tags:
        - Roles
      summary: Suppression rôle
      description: Supprimer rôle (admin uniquement, avec vérification utilisateurs)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
        - name: reassign_to
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Rôle supprimé
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  users_reassigned:
                    type: integer
        '422':
          description: Rôle utilisé sans réassignation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /roles/{id}/permissions:
    get:
      tags:
        - Roles
      summary: Récupération permissions rôle
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Permissions rôle
          content:
            application/json:
              schema:
                type: object
                properties:
                  permissions:
                    type: object
                    additionalProperties:
                      type: array
                      items:
                        type: string

    put:
      tags:
        - Roles
      summary: Configuration permissions rôle
      description: Configurer permissions rôle (admin uniquement)
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                permissions:
                  type: object
                  additionalProperties:
                    type: array
                    items:
                      type: string
                      enum: [READ, WRITE, MOD, DELETE]
      responses:
        '200':
          description: Permissions mises à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  users_affected:
                    type: integer

  /roles/{id}/users:
    get:
      tags:
        - Roles
      summary: Liste utilisateurs par rôle
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Liste utilisateurs
          content:
            application/json:
              schema:
                type: object
                properties:
                  users:
                    type: array
                    items:
                      $ref: '#/components/schemas/User'

  /config/system:
    get:
      tags:
        - Configurations
      summary: Paramètres système
      description: Récupérer paramètres système (admin uniquement)
      responses:
        '200':
          description: Paramètres système
          content:
            application/json:
              schema:
                type: object
                properties:
                  paths:
                    type: object
                    properties:
                      uploads:
                        type: string
                      releases:
                        type: string
                      cache:
                        type: string
                      logs:
                        type: string
                  limits:
                    type: object
                    properties:
                      max_file_size:
                        type: integer
                      api_timeout:
                        type: integer
                      ftp_timeout:
                        type: integer
                  logs:
                    type: object
                    properties:
                      level:
                        type: string
                      rotation_size:
                        type: integer
                      rotation_count:
                        type: integer
                      format:
                        type: string

    put:
      tags:
        - Configurations
      summary: Mise à jour paramètres système
      description: Modifier paramètres système (admin uniquement)
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                paths:
                  type: object
                limits:
                  type: object
                logs:
                  type: object
      responses:
        '200':
          description: Paramètres mis à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /config/apis:
    get:
      tags:
        - Configurations
      summary: Liste configurations APIs
      description: Liste configurations APIs externes (admin uniquement)
      parameters:
        - name: user_id
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Liste configurations APIs
          content:
            application/json:
              schema:
                type: object
                properties:
                  apis:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        name:
                          type: string
                        active:
                          type: boolean
                        user_id:
                          type: integer
                          nullable: true
                        configured:
                          type: boolean

    post:
      tags:
        - Configurations
      summary: Création configuration API
      description: Créer configuration API (admin uniquement, clé chiffrée)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - api_key
              properties:
                name:
                  type: string
                api_key:
                  type: string
                active:
                  type: boolean
                  default: true
                user_id:
                  type: integer
                  nullable: true
      responses:
        '201':
          description: Configuration API créée
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  message:
                    type: string

  /config/apis/{id}:
    put:
      tags:
        - Configurations
      summary: Modification configuration API
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                api_key:
                  type: string
                active:
                  type: boolean
      responses:
        '200':
          description: Configuration API modifiée
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  message:
                    type: string

    delete:
      tags:
        - Configurations
      summary: Suppression configuration API
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Configuration API supprimée
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /config/apis/{id}/test:
    post:
      tags:
        - Configurations
      summary: Test connexion API
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                query:
                  type: string
      responses:
        '200':
          description: Résultat test connexion
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  response_time:
                    type: integer
                    nullable: true
                  error:
                    type: string
                    nullable: true

  /config/destinations:
    get:
      tags:
        - Configurations
      summary: Liste destinations FTP/SSH
      description: Liste destinations FTP/SSH (admin uniquement)
      parameters:
        - name: user_id
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Liste destinations
          content:
            application/json:
              schema:
                type: object
                properties:
                  destinations:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: integer
                        name:
                          type: string
                        host:
                          type: string
                        port:
                          type: integer
                        user:
                          type: string
                        type:
                          type: string
                          enum: [FTP, SFTP, SSH]
                        user_id:
                          type: integer
                          nullable: true

    post:
      tags:
        - Configurations
      summary: Création destination FTP/SSH
      description: Créer destination (admin uniquement, password chiffré)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - host
                - user
                - password
                - type
              properties:
                name:
                  type: string
                host:
                  type: string
                port:
                  type: integer
                  default: 21
                user:
                  type: string
                password:
                  type: string
                  format: password
                type:
                  type: string
                  enum: [FTP, SFTP, SSH]
                options:
                  type: object
                user_id:
                  type: integer
                  nullable: true
      responses:
        '201':
          description: Destination créée
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  message:
                    type: string

  /config/destinations/{id}:
    put:
      tags:
        - Configurations
      summary: Modification destination
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                host:
                  type: string
                port:
                  type: integer
                user:
                  type: string
                password:
                  type: string
                  format: password
                options:
                  type: object
      responses:
        '200':
          description: Destination modifiée
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  message:
                    type: string

    delete:
      tags:
        - Configurations
      summary: Suppression destination
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Destination supprimée
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /config/destinations/{id}/test:
    post:
      tags:
        - Configurations
      summary: Test connexion FTP/SSH
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Résultat test connexion
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  response_time:
                    type: integer
                    nullable: true
                  error:
                    type: string
                    nullable: true

  /config/templates:
    get:
      tags:
        - Configurations
      summary: Configuration stockage templates
      description: Récupérer configuration stockage templates (admin uniquement)
      responses:
        '200':
          description: Configuration templates
          content:
            application/json:
              schema:
                type: object
                properties:
                  storage:
                    type: string
                    enum: [db, disk]
                  disk_path:
                    type: string
                    nullable: true
                  templates_count:
                    type: integer

    put:
      tags:
        - Configurations
      summary: Mise à jour configuration templates
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                storage:
                  type: string
                  enum: [db, disk]
                disk_path:
                  type: string
      responses:
        '200':
          description: Configuration mise à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /config/templates/migrate:
    post:
      tags:
        - Configurations
      summary: Migration templates
      description: Migrer templates disque ↔ DB (admin uniquement, asynchrone)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - from
                - to
              properties:
                from:
                  type: string
                  enum: [db, disk]
                to:
                  type: string
                  enum: [db, disk]
                disk_path:
                  type: string
      responses:
        '202':
          description: Migration démarrée
          content:
            application/json:
              schema:
                type: object
                properties:
                  job_id:
                    type: integer
                  status:
                    type: string
                  message:
                    type: string

  /config/preferences:
    get:
      tags:
        - Configurations
      summary: Préférences utilisateur
      description: Récupérer préférences utilisateur connecté
      parameters:
        - name: key
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Préférences utilisateur
          content:
            application/json:
              schema:
                type: object
                properties:
                  preferences:
                    type: object
                    additionalProperties: true

    put:
      tags:
        - Configurations
      summary: Mise à jour préférences
      description: Mettre à jour préférences utilisateur
      requestBody:
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: Préférences mises à jour
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

